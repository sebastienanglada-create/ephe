<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Consommation Gaz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Graphique */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 180px; gap: 1px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; }
        .bar { width: 100%; border-radius: 2px 2px 0 0; transition: height 0.3s; min-height: 2px; }
        .bar-wrapper:hover .bar { filter: brightness(1.2); }
        .bar-wrapper:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;
            white-space: pre; z-index: 20; border: 1px solid #4b5563; pointer-events: none; margin-bottom: 4px;
        }
        .bar-wrapper.real .bar { background-color: #10b981; }
        .bar-wrapper.estimated .bar { background-color: #6366f1; opacity: 0.8; }

        /* Calendrier */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 0.375rem; background-color: #374151; font-size: 0.75rem; position: relative; transition: all 0.2s; border: 1px solid transparent; }
        .day-cell.has-data:hover { transform: scale(1.1); z-index: 10; border-color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .intensity-bar { width: 80%; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; margin-top: 2px; overflow: hidden; }
        .real-data-marker { position: absolute; top: 2px; right: 2px; width: 4px; height: 4px; background-color: #10b981; border-radius: 50%; }

        /* Impression & Mobile */
        @media print { .print-hidden { display: none !important; } body { background: white !important; color: black !important; } .card { border: 1px solid #ccc !important; box-shadow: none !important; } }
        .fab { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem; border-radius: 9999px; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px rgba(0,0,0,0.3); z-index: 40; }
        @media (min-width: 1024px) { .fab { display: none; } }
    </style>
</head>
<body class="p-3 md:p-8 min-h-screen pb-24 lg:pb-8">

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center pb-4 border-b border-gray-700 print-hidden gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">Suivi Conso Gaz</h1>
                <p class="text-gray-400 text-sm mt-1">Import GRDF & Historique Index</p>
            </div>
            <div class="flex gap-2">
                <button onclick="triggerImport()" class="flex items-center space-x-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg transition shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Importer Fichier GRDF</span>
                </button>
                <input type="file" id="import-file" class="hidden" accept=".csv,.json" onchange="handleImport(this)">
                <button onclick="window.print()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition">Imprimer</button>
            </div>
        </header>

        <!-- GRILLE -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- GAUCHE -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Saisie -->
                <section class="card p-5 print-hidden lg:block">
                    <h2 class="text-lg font-semibold text-white mb-4">Ajouter Index (Manuel)</h2>
                    <form onsubmit="handleAdd(event, 'desktop')" class="space-y-4">
                        <div><label class="block text-xs text-gray-400 mb-1">Date</label><input type="datetime-local" id="input-date-desktop" required class="w-full bg-gray-700 border-gray-600 text-white text-sm rounded p-2.5"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">Index (m³)</label><input type="number" id="input-index-desktop" step="0.001" required class="w-full bg-gray-700 border-gray-600 text-white text-sm rounded p-2.5"></div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">Ajouter</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2 italic">Ajoutez ici les relevés récents non encore disponibles sur le site GRDF.</p>
                </section>

                <!-- Synthèse -->
                <section class="card p-5">
                    <h2 class="text-lg font-semibold text-white mb-4">Synthèse Totale</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <div class="text-xs text-gray-400">Consommation</div>
                            <div class="text-xl font-bold text-blue-400" id="total-kwh">0 kWh</div>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <div class="text-xs text-gray-400">Coût TTC</div>
                            <div class="text-xl font-bold text-emerald-400" id="total-cost">0.00 €</div>
                        </div>
                    </div>
                </section>

                <!-- Paramètres -->
                 <section class="card print-hidden">
                    <button onclick="document.getElementById('params-content').classList.toggle('hidden')" class="w-full p-5 flex justify-between items-center text-white font-semibold">
                        Paramètres <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="params-content" class="hidden px-5 pb-5 space-y-3 border-t border-gray-700 pt-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs text-gray-400">Prix kWh HT</label><input id="p-prix-kwh" value="0.0777" onchange="updateApp()" class="w-full bg-gray-700 text-white text-xs rounded p-2"></div>
                            <div><label class="text-xs text-gray-400">Coef. Gaz</label><input id="p-coef" value="11.361" onchange="updateApp()" class="w-full bg-gray-700 text-white text-xs rounded p-2"></div>
                            <div><label class="text-xs text-gray-400">Abo/Mois HT</label><input id="p-abo" value="16.72" onchange="updateApp()" class="w-full bg-gray-700 text-white text-xs rounded p-2"></div>
                            <div><label class="text-xs text-gray-400">TVA %</label><input id="p-tva-conso" value="20" onchange="updateApp()" class="w-full bg-gray-700 text-white text-xs rounded p-2"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- DROITE -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- HISTORIQUE DES INDEX (Demandé spécifiquement) -->
                <section class="card overflow-hidden border-indigo-500 border-t-4">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-white">Historique des Index</h2>
                        <span class="text-xs text-gray-400" id="index-count">0 relevés</span>
                    </div>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-gray-700/50 text-gray-200 uppercase text-xs sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3 text-right">Index (m³)</th>
                                    <th class="px-4 py-3 text-right">Diff. (m³)</th>
                                    <th class="px-4 py-3 text-right">Conso (kWh)</th>
                                    <th class="px-4 py-3 text-center print-hidden">Suppr.</th>
                                </tr>
                            </thead>
                            <tbody id="index-history-body" class="divide-y divide-gray-700">
                                <!-- Rempli par JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Graphique -->
                <section class="card p-5">
                    <div class="flex justify-between mb-4">
                        <h2 class="text-lg font-semibold text-white" id="chart-title">Évolution</h2>
                        <div class="flex gap-2 bg-gray-700 rounded p-1 text-xs">
                            <button onclick="setChartMode('month')" class="px-3 py-1 rounded hover:bg-gray-600">Mois</button>
                            <button onclick="setChartMode('day')" class="px-3 py-1 rounded bg-indigo-600 text-white">Jour</button>
                        </div>
                    </div>
                    <div id="monthly-chart" class="bar-container border-b border-gray-600"></div>
                </section>

                <!-- Calendrier -->
                <section class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-700 rounded-full"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"></path></svg></button>
                        <h2 class="text-lg font-bold text-white capitalize" id="calendar-month-label">--</h2>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-700 rounded-full"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg></button>
                    </div>
                    <div class="calendar-grid mb-2 text-center text-xs text-gray-500 font-medium">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid gap-1 md:gap-2"></div>
                </section>
                
                <!-- DATA TOOLS -->
                <section class="card p-4 mt-6 print-hidden flex justify-between items-center">
                    <div class="text-xs text-gray-500">Sauvegarde locale. Pensez à exporter.</div>
                    <button onclick="resetAll()" class="text-xs text-red-400 hover:text-red-300 underline">Réinitialiser Tout</button>
                </section>
            </div>
        </div>
    </div>

    <!-- FAB MOBILE -->
    <button onclick="document.getElementById('mobile-modal').classList.remove('hidden')" class="fab print-hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
    <div id="mobile-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-end sm:items-center justify-center print-hidden" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="bg-gray-800 w-full max-w-md p-6 rounded-t-2xl sm:rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Nouveau Relevé</h2>
            <form onsubmit="handleAdd(event, 'mobile')" class="space-y-4">
                <div><label class="block text-xs text-gray-400 mb-1">Date</label><input type="datetime-local" id="input-date-mobile" required class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded p-3"></div>
                <div><label class="block text-xs text-gray-400 mb-1">Index</label><input type="number" id="input-index-mobile" step="0.001" required class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded p-3"></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold rounded-lg text-lg px-5 py-3">Enregistrer</button>
            </form>
        </div>
    </div>

    <script>
        // --- ETAT ---
        const STATE = {
            indexHistory: [], // Relevés manuels ou import "mes-index"
            realDailyData: {}, // Données importées de "ma-conso-quotidienne"
            dailyData: {}, // Données finales (fusionnées)
            monthlyData: {},
            currentDate: new Date(),
            view: 'cost', chartMode: 'day',
            maxVal: 1, maxMonthVal: 1
        };

        window.onload = () => { initInputs(); loadData(); updateApp(); };

        function initInputs() {
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const iso = now.toISOString().slice(0, 16);
            if(document.getElementById('input-date-desktop')) document.getElementById('input-date-desktop').value = iso;
            if(document.getElementById('input-date-mobile')) document.getElementById('input-date-mobile').value = iso;
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('gaz_data_v3');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    STATE.indexHistory = parsed.indexHistory || [];
                    STATE.realDailyData = parsed.realDailyData || {};
                }
            } catch(e) { console.error("Reset data"); STATE.indexHistory=[]; STATE.realDailyData={}; }
        }
        function saveData() {
            localStorage.setItem('gaz_data_v3', JSON.stringify({
                indexHistory: STATE.indexHistory,
                realDailyData: STATE.realDailyData
            }));
        }

        function handleAdd(e, mode) {
            e.preventDefault(); const s = mode==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('input-date'+s).value;
            const i = parseFloat(document.getElementById('input-index'+s).value);
            if(!d || isNaN(i)) return alert("Invalide");
            
            STATE.indexHistory.push({id:Date.now(), date:d, index:i});
            saveData();
            document.getElementById('input-index'+s).value='';
            if(mode==='mobile') document.getElementById('mobile-modal').classList.add('hidden');
            updateApp();
        }

        // --- IMPORT INTELLIGENT (CORRIGÉ POUR IGNORER HEADER GRDF) ---
        function triggerImport() { document.getElementById('import-file').click(); }
        function handleImport(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                let count = 0;
                // Découpage ligne par ligne
                const lines = content.split(/\r?\n/);
                
                // Analyse du contenu pour deviner le type
                // On cherche une ligne qui contient les headers connus
                let headerIndex = -1;
                let fileType = 'unknown'; // 'index', 'daily', 'monthly'

                for(let i=0; i<Math.min(20, lines.length); i++) {
                    const l = lines[i].toLowerCase();
                    if(l.includes("date") && l.includes("index")) {
                        headerIndex = i; fileType = 'index'; break;
                    }
                    if(l.includes("date") && l.includes("consommation")) {
                        headerIndex = i; fileType = 'daily'; break;
                    }
                }

                if(fileType === 'unknown') {
                    alert("Type de fichier non reconnu. Assurez-vous d'importer un CSV GRDF (Index ou Conso Quotidienne).");
                    return;
                }

                // Traitement des données à partir de la ligne suivant le header
                for(let i=headerIndex+1; i<lines.length; i++) {
                    const line = lines[i].trim().replace(/"/g,'');
                    if(!line) continue;
                    
                    let parts = line.split(';');
                    if(parts.length < 2) parts = line.split(',');
                    if(parts.length < 2) continue;

                    // Extraction Date
                    const dateRaw = parts[0].trim();
                    let dateKey = null; // YYYY-MM-DD
                    
                    // Parsing DD/MM/YYYY
                    if(dateRaw.includes('/')) {
                        const [dd, mm, yyyy] = dateRaw.split('/');
                        if(yyyy && mm && dd) dateKey = `${yyyy}-${mm}-${dd}`;
                    } else if(dateRaw.includes('-')) {
                        dateKey = dateRaw.split(' ')[0]; // ISO
                    }

                    if(!dateKey) continue;

                    if(fileType === 'daily') {
                        // Format: Date; Conso; Coeff...
                        // GRDF peut mettre la conso en col 1 ou 2 selon export
                        let consoStr = parts[1];
                        // Si la colonne 1 n'est pas un nombre, essayer la 2
                        if(isNaN(parseFloat(consoStr.replace(',','.')))) consoStr = parts[2] || "0";

                        const consoVal = parseFloat(consoStr.replace(',','.'));
                        if(!isNaN(consoVal)) {
                            STATE.realDailyData[dateKey] = { m3: consoVal, kwh: consoVal * 11.2, source: 'real' }; // Coeff par défaut si manquant
                            count++;
                        }
                    } else if (fileType === 'index') {
                        // Format: Date; Type; Index...
                        let indexStr = parts[1];
                        // Si col 1 est texte (Type d'index), prendre col 2
                        if(isNaN(parseFloat(indexStr.replace(',','.')))) indexStr = parts[2] || "0";

                        const indexVal = parseFloat(indexStr.replace(',','.'));
                        if(!isNaN(indexVal) && indexVal > 0) {
                            // Eviter doublons
                            if(!STATE.indexHistory.some(h => h.date.startsWith(dateKey))) {
                                STATE.indexHistory.push({id:Date.now()+Math.random(), date:dateKey+"T12:00", index:indexVal});
                                count++;
                            }
                        }
                    }
                }

                if(count>0) { saveData(); updateApp(); alert(`${count} données importées !`); }
                else alert("Aucune donnée importée (format incorrect ou doublons).");
                input.value='';
            };
            reader.readAsText(file);
        }

        function deleteEntry(id) {
            if(confirm("Supprimer cet index ?")) {
                STATE.indexHistory = STATE.indexHistory.filter(h => h.id !== id);
                saveData();
                updateApp();
            }
        }
        
        function resetAll() { if(confirm("Tout effacer ?")) { STATE.indexHistory=[]; STATE.realDailyData={}; saveData(); updateApp(); } }

        // --- CALCUL HYBRIDE ---
        function updateApp() {
            const pKwh = parseFloat(document.getElementById('p-prix-kwh').value)||0.0777;
            const tva = parseFloat(document.getElementById('p-tva-conso').value)||20;
            const coef = parseFloat(document.getElementById('p-coef').value)||11.361;

            STATE.dailyData = {};
            STATE.monthlyData = {};
            STATE.maxVal = 0; STATE.maxMonthVal = 0;

            // 1. Données RÉELLES (Quotidiennes)
            Object.entries(STATE.realDailyData).forEach(([dateKey, data]) => {
                const costTTC = data.kwh * pKwh * (1 + tva/100);
                STATE.dailyData[dateKey] = { kwh: data.kwh, cost: costTTC, isReal: true };
            });

            // 2. INDEX (Estimation trous)
            STATE.indexHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            for(let i=1; i<STATE.indexHistory.length; i++) {
                const prev = STATE.indexHistory[i-1];
                const curr = STATE.indexHistory[i];
                const dStart = new Date(prev.date);
                const dEnd = new Date(curr.date);
                const diffDays = Math.ceil(Math.abs(dEnd - dStart) / (1000 * 60 * 60 * 24));
                
                if(diffDays <= 0) continue;
                const deltaIndex = curr.index - prev.index;
                const dailyKwh = (deltaIndex / diffDays) * coef;
                const dailyCost = dailyKwh * pKwh * (1 + tva/100);

                for(let j=0; j<diffDays; j++) {
                    const d = new Date(dStart); d.setDate(d.getDate() + j);
                    const key = d.toISOString().slice(0,10);
                    if(!STATE.dailyData[key]) {
                        STATE.dailyData[key] = { kwh: dailyKwh, cost: dailyCost, isReal: false };
                    }
                }
            }

            // 3. Agrégations
            let totKwh = 0, totCost = 0;
            Object.entries(STATE.dailyData).forEach(([key, val]) => {
                const m = key.slice(0,7); 
                if(!STATE.monthlyData[m]) STATE.monthlyData[m] = {kwh:0, cost:0};
                STATE.monthlyData[m].kwh += val.kwh;
                STATE.monthlyData[m].cost += val.cost;
                totKwh += val.kwh; totCost += val.cost;
                const v = STATE.view === 'kwh' ? val.kwh : val.cost;
                if(v > STATE.maxVal) STATE.maxVal = v;
            });
            Object.values(STATE.monthlyData).forEach(d => {
                const v = STATE.view === 'kwh' ? d.kwh : d.cost;
                if(v > STATE.maxMonthVal) STATE.maxMonthVal = v;
            });

            // UI Updates
            document.getElementById('total-kwh').innerText = Math.round(totKwh).toLocaleString() + ' kWh';
            document.getElementById('total-cost').innerText = totCost.toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            document.getElementById('index-count').innerText = STATE.indexHistory.length + ' relevés';

            renderIndexTable();
            renderCalendar();
            renderChart();
        }

        // --- RENDU TABLEAU INDEX ---
        function renderIndexTable() {
            const tbody = document.getElementById('index-history-body');
            tbody.innerHTML = '';
            const history = [...STATE.indexHistory].reverse();
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center italic">Aucun index. Importez un fichier ou ajoutez-en un.</td></tr>';
                return;
            }

            // Calculer les différences pour l'affichage
            // Comme on affiche à l'envers, l'élément précédent chronologique est à l'index suivant dans le tableau inversé
            for (let i = 0; i < history.length; i++) {
                const curr = history[i];
                const prev = history[i+1]; // Le plus ancien
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-700/50 transition border-b border-gray-700";
                
                const d = new Date(curr.date).toLocaleDateString('fr-FR');
                
                let diffM3 = '-', consoKwh = '-';
                if (prev) {
                    const diff = curr.index - prev.index;
                    diffM3 = diff.toFixed(0);
                    const coef = parseFloat(document.getElementById('p-coef').value) || 11.36;
                    consoKwh = Math.round(diff * coef);
                }

                tr.innerHTML = `
                    <td class="px-4 py-3 text-white">${d}</td>
                    <td class="px-4 py-3 text-right font-mono text-indigo-300 font-bold">${curr.index}</td>
                    <td class="px-4 py-3 text-right text-gray-400">${diffM3}</td>
                    <td class="px-4 py-3 text-right text-gray-400">${consoKwh}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteEntry(${curr.id})" class="text-red-400 hover:text-red-300 hover:bg-gray-600 rounded p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        // --- RENDER CALENDRIER ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const y = STATE.currentDate.getFullYear();
            const m = STATE.currentDate.getMonth();
            document.getElementById('calendar-month-label').innerText = new Date(y, m, 1).toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
            const firstDay = new Date(y, m, 1).getDay() || 7; 
            const daysInMonth = new Date(y, m+1, 0).getDate();

            for(let i=1; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const data = STATE.dailyData[dateStr];
                const cell = document.createElement('div');
                cell.className = "day-cell border border-gray-700/50";

                if(data) {
                    const val = STATE.view === 'kwh' ? data.kwh : data.cost;
                    const ratio = STATE.maxVal > 0 ? val / STATE.maxVal : 0;
                    cell.classList.add('has-data');
                    let bg = '#374151';
                    if(val > 0) {
                        if(ratio < 0.25) bg = '#064e3b'; else if(ratio < 0.5) bg = '#713f12'; else if(ratio < 0.75) bg = '#7c2d12'; else bg = '#7f1d1d';
                    }
                    cell.style.backgroundColor = bg;
                    if(data.isReal) {
                        const marker = document.createElement('div'); marker.className = 'real-data-marker'; cell.appendChild(marker);
                    }
                    const dispVal = STATE.view === 'kwh' ? Math.round(val) : val.toFixed(1);
                    cell.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 text-[0.65rem] text-gray-200 mt-1">${dispVal}</div>`;
                    const bar = document.createElement('div'); bar.className="intensity-bar";
                    const f = document.createElement('div'); f.className="intensity-fill"; f.style.width = `${Math.min(100, ratio*100)}%`; f.style.backgroundColor = ratio > 0.5 ? '#fcd34d' : '#34d399';
                    bar.appendChild(f); cell.appendChild(bar);
                    cell.title = `${dateStr}\n${data.isReal ? "Réel" : "Estimé"}: ${val.toFixed(2)} ${STATE.view==='kwh'?'kWh':'€'}`;
                } else { cell.innerHTML = `<span class="text-gray-600">${d}</span>`; }
                grid.appendChild(cell);
            }
        }

        // --- RENDER CHART ---
        function renderChart() {
            const container = document.getElementById('monthly-chart'); container.innerHTML = '';
            const isDayMode = STATE.chartMode === 'day';
            
            if(isDayMode) {
                const y = STATE.currentDate.getFullYear(); const m = STATE.currentDate.getMonth();
                const daysInMonth = new Date(y, m+1, 0).getDate();
                let localMax = 0;
                for(let d=1; d<=daysInMonth; d++) {
                     const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                     if(STATE.dailyData[k]) { const v = STATE.view === 'kwh' ? STATE.dailyData[k].kwh : STATE.dailyData[k].cost; if(v > localMax) localMax = v; }
                }
                for(let d=1; d<=daysInMonth; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    let val = 0, isReal = false;
                    if(STATE.dailyData[k]) { val = STATE.view === 'kwh' ? STATE.dailyData[k].kwh : STATE.dailyData[k].cost; isReal = STATE.dailyData[k].isReal; }
                    const p = localMax > 0 ? (val / localMax * 100) : 0;
                    const div = document.createElement('div'); div.className = `bar-wrapper dense ${isReal ? 'real' : 'estimated'}`; div.setAttribute('data-tooltip', `${d}: ${val.toFixed(1)}`);
                    div.innerHTML = `<div class="bar" style="height: ${Math.max(1, p)}%"></div><div class="bar-label">${d}</div>`; container.appendChild(div);
                }
            } else {
                const keys = Object.keys(STATE.monthlyData).sort();
                keys.forEach(k => {
                    const d = STATE.monthlyData[k]; const val = STATE.view === 'kwh' ? d.kwh : d.cost;
                    const p = STATE.maxMonthVal > 0 ? (val / STATE.maxMonthVal * 100) : 0;
                    const [y, m] = k.split('-'); const lbl = new Date(y, m-1, 1).toLocaleDateString('fr-FR', {month:'short', year:'2-digit'});
                    const div = document.createElement('div'); div.className = 'bar-wrapper estimated'; 
                    div.setAttribute('data-tooltip', `${lbl}: ${Math.round(val)}`);
                    div.innerHTML = `<div class="bar" style="height: ${Math.max(2, p)}%"></div><div class="bar-label">${lbl}</div>`; container.appendChild(div);
                });
            }
        }

        function changeMonth(d) { STATE.currentDate.setMonth(STATE.currentDate.getMonth() + d); renderCalendar(); if(STATE.chartMode==='day') renderChart(); }
        function setView(v) { STATE.view = v; updateApp(); }
        function setChartMode(m) { STATE.chartMode = m; renderChart(); }
        function toggleParams() { document.getElementById('params-content').classList.toggle('hidden'); }
    </script>
</body>
</html>
