<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Gaz (Hybride Expert)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; }
        
        /* UI Components */
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Graphique */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 220px; gap: 1px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; min-width: 2px; }
        .bar { width: 100%; border-radius: 2px 2px 0 0; transition: all 0.3s; min-height: 2px; }
        .bar-wrapper:hover .bar { filter: brightness(1.3); z-index: 10; transform: scaleX(1.5); }
        
        /* Tooltip Graphique */
        .bar-wrapper:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600;
            white-space: pre; z-index: 50; border: 1px solid #4b5563; pointer-events: none; margin-bottom: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* Couleurs Sources */
        .real .bar { background-color: #10b981; } /* Vert = GRDF Réel */
        .estimated .bar { background-color: #8b5cf6; } /* Violet = Estimé par Index */
        
        /* Calendrier */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px; background-color: #374151; font-size: 0.75rem; position: relative; border: 1px solid transparent; }
        .day-cell.has-data:hover { transform: scale(1.15); z-index: 20; border-color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background-color: #4b5563; }
        
        /* Marqueurs */
        .marker-dot { position: absolute; top: 3px; right: 3px; width: 6px; height: 6px; border-radius: 50%; }
        .bg-real { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        
        /* Heatmap Bar */
        .intensity-bar { width: 80%; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 2px; overflow: hidden; }
        .intensity-fill { height: 100%; border-radius: 2px; }

        /* Mobile & Print */
        @media print { .print-hidden { display: none !important; } body { background: white; color: black; } .card { border: 1px solid #ccc; } }
        .fab { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem; border-radius: 9999px; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.4); z-index: 50; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        @media (min-width: 1024px) { .fab { display: none; } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen pb-24">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center pb-4 border-b border-gray-700 print-hidden gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Suivi Gaz <span class="text-indigo-400">Expert</span></h1>
                <div class="flex items-center gap-4 mt-2 text-xs text-gray-400 font-medium">
                    <span class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500 mr-1.5 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span> Réel (GRDF)</span>
                    <span class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-violet-500 mr-1.5"></span> Estimé (Index)</span>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="document.getElementById('file-input').click()" class="flex items-center space-x-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold rounded-lg transition shadow-lg transform hover:scale-105 active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Importer (CSV GRDF)</span>
                </button>
                <input type="file" id="file-input" class="hidden" accept=".csv,.json,.txt" onchange="handleImport(this)" multiple>
                
                <button onclick="exportData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition">Sauvegarder</button>
                <button onclick="window.print()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition">Imprimer</button>
            </div>
        </header>

        <!-- GRILLE -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLONNE GAUCHE -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- SAISIE MANUELLE -->
                <section class="card p-5 print-hidden lg:block">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Saisie Index Manuel</h2>
                    <form onsubmit="addManualIndex(event, 'desktop')" class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Date</label>
                            <input type="datetime-local" id="date-desktop" required class="w-full bg-gray-800 border border-gray-600 text-white text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Index Compteur (m³)</label>
                            <input type="number" id="index-desktop" step="0.001" required placeholder="Ex: 5488" class="w-full bg-gray-800 border border-gray-600 text-white text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg text-sm px-5 py-3 transition shadow-lg">Ajouter</button>
                    </form>
                </section>

                <!-- SYNTHÈSE DYNAMIQUE (AVEC TRI PERSONNALISÉ) -->
                <section class="card p-5">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-lg font-bold text-white">Synthèse</h2>
                        <div class="flex bg-gray-800 rounded p-1 gap-1 flex-wrap">
                            <button onclick="setSynth('global')" id="btn-sy-global" class="px-2 py-1 text-xs rounded bg-indigo-600 text-white">Global</button>
                            <button onclick="setSynth('year')" id="btn-sy-year" class="px-2 py-1 text-xs rounded text-gray-400 hover:text-white">An</button>
                            <button onclick="setSynth('month')" id="btn-sy-month" class="px-2 py-1 text-xs rounded text-gray-400 hover:text-white">Mois</button>
                            <button onclick="setSynth('custom')" id="btn-sy-custom" class="px-2 py-1 text-xs rounded text-gray-400 hover:text-white">Perso</button>
                        </div>
                    </div>
                    
                    <!-- Filtres dynamiques -->
                    <div id="synth-controls" class="mb-4 hidden space-y-2">
                        <select id="synth-year-select" onchange="updateSynth()" class="w-full bg-gray-700 text-white text-xs rounded p-2 hidden"></select>
                        <input type="month" id="synth-month-select" onchange="updateSynth()" class="w-full bg-gray-700 text-white text-xs rounded p-2 hidden">
                        <div id="synth-custom-range" class="hidden flex gap-2">
                            <input type="date" id="synth-start" onchange="updateSynth()" class="w-1/2 bg-gray-700 text-white text-xs rounded p-2">
                            <input type="date" id="synth-end" onchange="updateSynth()" class="w-1/2 bg-gray-700 text-white text-xs rounded p-2">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                            <div class="text-[0.65rem] text-gray-500 uppercase font-bold">Volume</div>
                            <div class="text-xl font-bold text-blue-400 mt-1" id="disp-m3">0 m³</div>
                            <div class="text-xs text-blue-300/70 mt-1" id="disp-kwh">0 kWh</div>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                            <div class="text-[0.65rem] text-gray-500 uppercase font-bold">Coût TTC</div>
                            <div class="text-xl font-bold text-emerald-400 mt-1" id="disp-cost">0 €</div>
                            <div class="text-xs text-gray-400 mt-1" id="disp-cost-ht">HT: 0 €</div>
                        </div>
                        <div class="col-span-2 text-[0.65rem] text-center text-gray-500 italic" id="synth-label">Période globale</div>
                    </div>
                </section>

                <!-- PARAMÈTRES -->
                <section class="card print-hidden">
                    <button onclick="document.getElementById('params-box').classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center hover:bg-gray-800 transition rounded-lg">
                        <span class="text-sm font-semibold text-gray-300">Paramètres Facture</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="params-box" class="hidden px-4 pb-4 pt-2 border-t border-gray-700 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[0.6rem] uppercase text-gray-500">Prix kWh HT</label><input id="p-kwh" type="number" step="0.0001" value="0.0777" onchange="recalc()" class="w-full bg-gray-900 text-white text-xs rounded p-2 border border-gray-700"></div>
                            <div><label class="text-[0.6rem] uppercase text-gray-500">Abo/Mois HT</label><input id="p-abo" type="number" step="0.01" value="16.72" onchange="recalc()" class="w-full bg-gray-900 text-white text-xs rounded p-2 border border-gray-700"></div>
                            <div><label class="text-[0.6rem] uppercase text-gray-500">TVA Conso %</label><input id="p-tva1" type="number" step="0.1" value="20" onchange="recalc()" class="w-full bg-gray-900 text-white text-xs rounded p-2 border border-gray-700"></div>
                            <div><label class="text-[0.6rem] uppercase text-gray-500">TVA Abo %</label><input id="p-tva2" type="number" step="0.1" value="5.5" onchange="recalc()" class="w-full bg-gray-900 text-white text-xs rounded p-2 border border-gray-700"></div>
                            <div class="col-span-2"><label class="text-[0.6rem] uppercase text-gray-500">Coef. Conv.</label><input id="p-coef" type="number" step="0.01" value="11.36" onchange="recalc()" class="w-full bg-gray-900 text-white text-xs rounded p-2 border border-gray-700"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- COLONNE DROITE -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- GRAPHIQUE -->
                <section class="card p-5">
                    <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span id="chart-title">Évolution</span>
                        </h2>
                        <div class="flex gap-2">
                            <div class="flex bg-gray-800 rounded p-1 text-xs">
                                <button onclick="setChart('day')" id="btn-chart-day" class="px-3 py-1 rounded bg-indigo-600 text-white transition">Jour</button>
                                <button onclick="setChart('month')" id="btn-chart-month" class="px-3 py-1 rounded text-gray-400 hover:text-white transition">Mois</button>
                            </div>
                            <div class="flex bg-gray-800 rounded p-1 text-xs">
                                <button onclick="setView('cost')" id="btn-view-cost" class="px-3 py-1 rounded bg-emerald-600 text-white transition">€</button>
                                <button onclick="setView('kwh')" id="btn-view-kwh" class="px-3 py-1 rounded text-gray-400 hover:text-white transition">kWh</button>
                            </div>
                        </div>
                    </div>
                    <div id="chart-container" class="bar-container border-b border-gray-600"></div>
                    <div id="chart-empty" class="hidden h-full flex items-center justify-center text-gray-500 text-sm italic py-10">Aucune donnée pour cette période</div>
                </section>

                <!-- CALENDRIER -->
                <section class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="moveCal(-1)" class="p-1.5 hover:bg-gray-700 rounded-lg transition"><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <h2 class="text-lg font-bold text-white capitalize w-40 text-center" id="cal-title">--</h2>
                        <button onclick="moveCal(1)" class="p-1.5 hover:bg-gray-700 rounded-lg transition"><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                    <div class="calendar-grid mb-2 text-center text-[0.65rem] text-gray-500 font-bold uppercase tracking-widest">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
                    </div>
                    <div id="cal-grid" class="calendar-grid gap-1"></div>
                </section>

                <!-- HISTORIQUE (Index) -->
                <section class="card overflow-hidden">
                    <button onclick="document.getElementById('hist-content').classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center hover:bg-gray-800 transition">
                        <h2 class="text-lg font-semibold text-white">Historique des Index</h2>
                        <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="hist-content" class="hidden max-h-80 overflow-y-auto">
                        <table class="w-full text-left text-xs text-gray-400">
                            <thead class="bg-gray-700 text-gray-200 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2">Date</th>
                                    <th class="px-4 py-2 text-right">Index</th>
                                    <th class="px-4 py-2 text-right">Conso Estimée</th>
                                    <th class="px-4 py-2 text-center print-hidden">Act</th>
                                </tr>
                            </thead>
                            <tbody id="hist-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </section>
                
                <!-- Reset -->
                <div class="flex justify-end pt-4 print-hidden">
                    <button onclick="resetAll()" class="text-xs text-red-400 hover:text-red-300 underline">Réinitialiser toutes les données</button>
                </div>

            </div>
        </div>
    </div>

    <!-- MOBILE MODAL -->
    <div id="mob-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="bg-gray-800 w-full max-w-sm p-6 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-xl font-bold text-white mb-6">Ajouter Index</h2>
            <form onsubmit="addManualIndex(event, 'mobile')" class="space-y-5">
                <input type="datetime-local" id="date-mobile" required class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none">
                <input type="number" id="index-mobile" step="0.001" required placeholder="Index m³" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none">
                <button class="w-full bg-indigo-600 text-white font-bold p-3 rounded-lg shadow-lg">Sauvegarder</button>
            </form>
        </div>
    </div>
    <button onclick="openMob()" class="fab print-hidden flex lg:hidden"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg></button>

    <script>
        // --- STATE ---
        const APP = {
            db: { indexes: [], realDays: {}, computedDays: {}, monthly: {} },
            ui: { view: 'cost', chartMode: 'day', synthMode: 'global', synthFilter: {}, calDate: new Date() },
            limits: { maxD: 1, maxM: 1 }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initInputs();
            loadDB();
            recalc();
        });

        function initInputs() {
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const iso = now.toISOString().slice(0, 16);
            if(document.getElementById('date-desktop')) document.getElementById('date-desktop').value = iso;
            if(document.getElementById('date-mobile')) document.getElementById('date-mobile').value = iso;
            
            const y = new Date().getFullYear();
            const m = new Date().toISOString().slice(0,7);
            const dStart = `${y}-01-01`;
            const dEnd = new Date().toISOString().slice(0,10);
            APP.ui.synthFilter = { year: y, month: m, start: dStart, end: dEnd };
        }

        // --- PERSISTENCE ---
        function loadDB() {
            try {
                const s = localStorage.getItem('gaz_db_v5');
                if(s) {
                    const d = JSON.parse(s);
                    APP.db.indexes = d.indexes || [];
                    APP.db.realDays = d.realDays || {};
                }
            } catch(e) { console.error("Err load", e); }
        }
        function saveDB() {
            localStorage.setItem('gaz_db_v5', JSON.stringify({ indexes: APP.db.indexes, realDays: APP.db.realDays }));
        }

        // --- IMPORT ---
        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const c = e.target.result;
                try {
                    if(f.name.endsWith('.json') || c.trim().startsWith('{')) {
                        const j = JSON.parse(c);
                        if(j.indexes) APP.db.indexes = j.indexes;
                        if(j.realDays) APP.db.realDays = j.realDays;
                        alert("Restauration réussie !");
                    } else {
                        // CSV Parsing
                        let countR=0, countI=0;
                        const lines = c.split(/\r?\n/);
                        const head = lines.slice(0,10).join(' ').toLowerCase();
                        const isDaily = head.includes('consommation') && head.includes('date');
                        const isIndex = head.includes('index') && (head.includes('relevé') || head.includes('distributeur'));

                        lines.forEach(l => {
                            const cl = l.replace(/"/g, '').trim();
                            if(!cl || !/\d/.test(cl)) return;
                            let p = cl.split(';'); if(p.length<2) p=cl.split(',');
                            if(p.length<2) return;

                            // Date
                            let dk = null;
                            if(p[0].match(/^\d{2}\/\d{2}\/\d{4}$/)) { const[d,m,y]=p[0].split('/'); dk=`${y}-${m}-${d}`; }
                            else if(p[0].match(/^\d{4}-\d{2}-\d{2}/)) { dk=p[0].split(' ')[0]; }
                            if(!dk) return;

                            if(isDaily) {
                                let vStr = p[1]; 
                                if(isNaN(parseFloat(vStr.replace(',','.'))) && p[2]) vStr=p[2];
                                const m3 = parseFloat(vStr.replace(',','.'));
                                let coef = 11.2;
                                if(p[2] && !isNaN(parseFloat(p[2].replace(',','.')))) coef = parseFloat(p[2].replace(',','.'));
                                if(p[3] && !isNaN(parseFloat(p[3].replace(',','.')))) coef = parseFloat(p[3].replace(',','.'));
                                
                                if(!isNaN(m3)) {
                                    APP.db.realDays[dk] = { m3: m3, kwh: m3*coef };
                                    countR++;
                                }
                            } else if(isIndex) {
                                let iStr = p[1];
                                if(isNaN(parseFloat(iStr.replace(',','.'))) && p[2]) iStr=p[2];
                                const idx = parseFloat(iStr.replace(',','.'));
                                if(!isNaN(idx) && idx>100) {
                                    if(!APP.db.indexes.some(x=>x.date.startsWith(dk))) {
                                        APP.db.indexes.push({id:Date.now()+Math.random(), date:dk+"T12:00", index:idx});
                                        countI++;
                                    }
                                }
                            }
                        });
                        alert(`Importé: ${countR} jours réels, ${countI} index.`);
                    }
                    saveDB(); recalc();
                } catch(err) { alert("Erreur: "+err.message); }
                input.value='';
            };
            r.readAsText(f);
        }

        function exportData() {
            const b = new Blob([JSON.stringify({indexes: APP.db.indexes, realDays: APP.db.realDays})], {type:'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=u; a.download=`gaz_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- CALCULATION ---
        function recalc() {
            const P = getParams();
            APP.db.computedDays = {}; APP.db.monthly = {};
            APP.limits.maxD = 0; APP.limits.maxM = 0;

            // 1. Real Data
            for(const [k,v] of Object.entries(APP.db.realDays)) {
                const cH = v.kwh * P.kwh;
                const cT = (cH*(1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));
                APP.db.computedDays[k] = { ...v, cost: cT, type: 'real' };
            }

            // 2. Indexes (Fill gaps)
            APP.db.indexes.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            for(let i=1; i<APP.db.indexes.length; i++) {
                const p = APP.db.indexes[i-1]; const c = APP.db.indexes[i];
                const d1 = new Date(p.date); const d2 = new Date(c.date);
                const days = Math.ceil((d2-d1)/(86400000));
                if(days<=0) continue;

                const totM3 = c.index - p.index;
                if(totM3 < 0) continue;

                const totKwh = totM3 * P.coef;
                let realKwh = 0, missing = [];

                for(let j=0; j<days; j++) {
                    const d = new Date(d1); d.setDate(d.getDate()+j);
                    const k = d.toISOString().slice(0,10);
                    if(APP.db.computedDays[k] && APP.db.computedDays[k].type==='real') {
                        realKwh += APP.db.computedDays[k].kwh;
                    } else {
                        missing.push(k);
                    }
                }

                if(missing.length > 0) {
                    const remKwh = Math.max(0, totKwh - realKwh);
                    const estDay = remKwh / missing.length;
                    const estM3 = (totM3 - (realKwh/P.coef)) / missing.length;
                    const costDay = (estDay * P.kwh * (1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));

                    missing.forEach(k => {
                        if(!APP.db.computedDays[k]) APP.db.computedDays[k] = { kwh: estDay, m3: Math.max(0,estM3), cost: costDay, type: 'estimated' };
                    });
                }
            }

            // 3. Aggregate
            for(const [k,v] of Object.entries(APP.db.computedDays)) {
                const m = k.slice(0,7);
                if(!APP.db.monthly[m]) APP.db.monthly[m] = { kwh:0, cost:0, m3:0 };
                APP.db.monthly[m].kwh += v.kwh;
                APP.db.monthly[m].cost += v.cost;
                APP.db.monthly[m].m3 += v.m3;

                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val > APP.limits.maxD) APP.limits.maxD = val;
            }
            
            // Max month
            for(const v of Object.values(APP.db.monthly)) {
                const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                if(val > APP.limits.maxM) APP.limits.maxM = val;
            }

            updateUI();
        }

        function updateUI() {
            renderSynth();
            renderChart();
            renderCal();
            renderHist();
        }

        // --- RENDERERS ---
        function renderSynth() {
            const controls = document.getElementById('synth-controls');
            const ys = document.getElementById('synth-year-select');
            const ms = document.getElementById('synth-month-select');
            const cs = document.getElementById('synth-custom-range');
            
            const mode = APP.ui.synthMode;
            
            // UI Buttons
            ['global','year','month','custom'].forEach(m => {
                const b = document.getElementById('btn-sy-'+m);
                b.className = (m===mode) ? "px-2 py-1 text-xs rounded text-white bg-indigo-600" : "px-2 py-1 text-xs rounded text-gray-400 hover:text-white";
            });

            // Show/Hide controls
            controls.classList.add('hidden'); ys.classList.add('hidden'); ms.classList.add('hidden'); cs.classList.add('hidden');
            
            if (mode !== 'global') {
                controls.classList.remove('hidden');
                if(mode === 'year') {
                    ys.classList.remove('hidden');
                    const years = [...new Set(Object.keys(APP.db.monthly).map(k=>k.slice(0,4)))].sort().reverse();
                    if(years.length===0) years.push(new Date().getFullYear());
                    if(ys.options.length !== years.length) {
                        ys.innerHTML = ''; years.forEach(y => ys.add(new Option(y, y)));
                    }
                    ys.value = APP.ui.synthFilter.year;
                } else if (mode === 'month') {
                    ms.classList.remove('hidden');
                    ms.value = APP.ui.synthFilter.month;
                } else if (mode === 'custom') {
                    cs.classList.remove('hidden');
                    document.getElementById('synth-start').value = APP.ui.synthFilter.start;
                    document.getElementById('synth-end').value = APP.ui.synthFilter.end;
                }
            }

            // Calc Sum
            let start=null, end=null, label="Global";
            if(mode === 'year') { start=new Date(APP.ui.synthFilter.year,0,1); end=new Date(APP.ui.synthFilter.year,11,31); label=APP.ui.synthFilter.year; }
            else if(mode === 'month') { const [y,m]=APP.ui.synthFilter.month.split('-'); start=new Date(y,m-1,1); end=new Date(y,m,0); label=APP.ui.synthFilter.month; }
            else if(mode === 'custom') { start=new Date(APP.ui.synthFilter.start); end=new Date(APP.ui.synthFilter.end); label="Période"; }

            let tk=0, tc=0, tm=0;
            let htK=0, htA=0;
            const P = getParams();

            Object.entries(APP.db.computedDays).forEach(([k,v]) => {
                const d = new Date(k);
                if(start && d < start) return;
                if(end && d > end) return;
                tk += v.kwh; tc += v.cost; tm += v.m3;
                htK += v.kwh * P.kwh;
                htA += (P.abo * 12 / 365);
            });

            document.getElementById('disp-m3').innerText = tm.toLocaleString('fr-FR', {maximumFractionDigits:1}) + ' m³';
            document.getElementById('disp-kwh').innerText = Math.round(tk).toLocaleString() + ' kWh';
            document.getElementById('disp-cost').innerText = tc.toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            document.getElementById('disp-cost-ht').innerText = 'HT: ' + (htK+htA).toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            document.getElementById('synth-label').innerText = label;
        }

        function updateSynth() {
            APP.ui.synthFilter.year = document.getElementById('synth-year-select').value;
            APP.ui.synthFilter.month = document.getElementById('synth-month-select').value;
            APP.ui.synthFilter.start = document.getElementById('synth-start').value;
            APP.ui.synthFilter.end = document.getElementById('synth-end').value;
            renderSynth();
        }

        function renderChart() {
            const c = document.getElementById('chart-container'); c.innerHTML='';
            const isDay = APP.ui.chartMode === 'day';
            
            // Buttons
            document.getElementById('btn-chart-day').className = isDay ? "px-3 py-1 rounded bg-indigo-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";
            document.getElementById('btn-chart-month').className = !isDay ? "px-3 py-1 rounded bg-indigo-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";
            document.getElementById('btn-view-cost').className = APP.ui.view==='cost' ? "px-3 py-1 rounded bg-emerald-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";
            document.getElementById('btn-view-kwh').className = APP.ui.view==='kwh' ? "px-3 py-1 rounded bg-indigo-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";

            let data = {}, max = 0;

            if(isDay) {
                const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
                const dim = new Date(y,m+1,0).getDate();
                document.getElementById('chart-title').innerText = "Évolution " + new Date(y,m,1).toLocaleDateString('fr-FR', {month:'long', year:'numeric'});

                for(let d=1; d<=dim; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const v = APP.db.computedDays[k];
                    const val = v ? (APP.ui.view==='kwh'?v.kwh:v.cost) : 0;
                    if(val>max) max=val;
                    data[d] = { val, type: v?.type, label: d };
                }
            } else {
                document.getElementById('chart-title').innerText = "Évolution Annuelle";
                const keys = Object.keys(APP.db.monthly).sort();
                keys.forEach(k => {
                    const v = APP.db.monthly[k];
                    const val = APP.ui.view==='kwh'?v.kwh:v.cost;
                    if(val>max) max=val;
                    const [yy,mm] = k.split('-');
                    const lbl = new Date(yy,mm-1,1).toLocaleDateString('fr-FR', {month:'short', year:'2-digit'});
                    data[k] = { val, type: 'mixed', label: lbl };
                });
            }

            const keys = Object.keys(data).sort();
            if(keys.length === 0 || max === 0) { document.getElementById('chart-empty').classList.remove('hidden'); return; }
            document.getElementById('chart-empty').classList.add('hidden');

            keys.forEach(k => {
                const item = data[k];
                const p = (item.val / max) * 100;
                const el = document.createElement('div');
                el.className = `bar-wrapper ${item.type||'estimated'} ${keys.length>20?'dense':''}`;
                el.setAttribute('data-tooltip', `${item.label}: ${item.val.toFixed(1)}`);
                el.innerHTML = `<div class="bar" style="height:${Math.max(2, p)}%"></div><div class="bar-label">${item.label}</div>`;
                c.appendChild(el);
            });
        }

        function renderCal() {
            const g = document.getElementById('cal-grid'); g.innerHTML='';
            const y = APP.ui.calDate.getFullYear(), m = APP.ui.calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m,1).toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
            
            const fd = new Date(y,m,1).getDay() || 7;
            const dim = new Date(y,m+1,0).getDate();

            for(let i=1; i<fd; i++) g.appendChild(document.createElement('div'));

            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const v = APP.db.computedDays[k];
                const c = document.createElement('div'); c.className = "day-cell border border-gray-700/50";
                
                if(v) {
                    c.classList.add('has-data');
                    const val = APP.ui.view==='kwh' ? v.kwh : v.cost;
                    const max = APP.limits.maxD;
                    const r = max>0 ? val/max : 0;
                    
                    let bg = '#374151';
                    if(val>0) { if(r<0.25) bg='#064e3b'; else if(r<0.5) bg='#713f12'; else if(r<0.75) bg='#7c2d12'; else bg='#7f1d1d'; }
                    c.style.backgroundColor = bg;

                    if(v.type==='real') c.innerHTML += `<div class="marker-dot bg-real"></div>`;
                    
                    c.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 day-val text-gray-200">${Math.round(val)}</div>`;
                    
                    const b = document.createElement('div'); b.className="intensity-bar";
                    const f = document.createElement('div'); f.className="intensity-fill"; 
                    f.style.width=`${r*100}%`; f.style.background = r>0.5?'#fcd34d':'#34d399';
                    b.appendChild(f); c.appendChild(b);
                    
                    c.title = `${k}\n${v.type}\n${val.toFixed(2)}`;
                } else {
                    c.innerHTML = `<span class="text-gray-600">${d}</span>`;
                }
                g.appendChild(c);
            }
        }

        function renderHist() {
            const b = document.getElementById('hist-body'); b.innerHTML='';
            const rows = [...APP.db.indexes].reverse();
            rows.forEach(r => {
                // Trouver conso estimée periode
                let det = '-';
                // Find next index in chronological order
                const idx = APP.db.indexes.indexOf(r);
                if(idx > 0) {
                    const prev = APP.db.indexes[idx-1];
                    const diff = r.index - prev.index;
                    // Calculer Coût Période
                    const P = getParams();
                    const cost = (diff * P.coef * P.kwh * (1+P.tva1)); // Approx
                    det = `<div>${diff.toFixed(0)} m³</div><div class="text-emerald-400 text-[0.65rem]">~${cost.toFixed(0)}€</div>`;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-800 border-b border-gray-700";
                tr.innerHTML = `
                    <td class="px-4 py-2 text-gray-300">${new Date(r.date).toLocaleDateString()}</td>
                    <td class="px-4 py-2 text-right text-white font-mono">${r.index}</td>
                    <td class="px-4 py-2 text-right text-xs text-gray-400">${det}</td>
                    <td class="px-4 py-2 text-center"><button onclick="delIndex(${r.id})" class="text-red-400 hover:text-white">×</button></td>
                `;
                b.appendChild(tr);
            });
        }

        // --- ACTIONS ---
        function addManualIndex(e, m) {
            e.preventDefault(); const s = m==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('date'+s).value;
            const v = parseFloat(document.getElementById('index'+s).value);
            if(APP.db.indexes.some(x=>x.date===d)) return alert("Date existe déjà");
            APP.db.indexes.push({ id: Date.now(), date: d, index: v });
            saveDB(); recalc();
            document.getElementById('index'+s).value='';
            if(m==='mobile') document.getElementById('mob-modal').classList.add('hidden');
        }
        function delIndex(id) { if(confirm("Supprimer ?")) { APP.db.indexes = APP.db.indexes.filter(x=>x.id!==id); saveDB(); recalc(); } }
        function resetAll() { if(confirm("TOUT EFFACER ?")) { localStorage.removeItem('gaz_db_v5'); APP.db.indexes = []; APP.db.realDays = {}; recalc(); } }
        
        // Utils
        function setSynthMode(m) { APP.ui.synthMode = m; renderSynth(); }
        function setView(v) { APP.ui.view = v; updateUI(); }
        function setChartMode(m) { APP.ui.chartMode = m; renderChart(); }
        function moveCal(d) { APP.ui.calDate.setMonth(APP.ui.calDate.getMonth()+d); renderCal(); }
        function openMob() { initDates(); document.getElementById('mob-modal').classList.remove('hidden'); }
        function getParams() {
            return {
                kwh: parseFloat(document.getElementById('p-kwh').value)||0.0777,
                abo: parseFloat(document.getElementById('p-abo').value)||16.72,
                coef: parseFloat(document.getElementById('p-coef').value)||11.36,
                tva1: (parseFloat(document.getElementById('p-tva1').value)||20)/100,
                tva2: (parseFloat(document.getElementById('p-tva2').value)||5.5)/100
            };
        }
    </script>
</body>
</html>
