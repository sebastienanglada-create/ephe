<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Gaz (Hybride)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Graphique */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 200px; gap: 1px; padding-top: 20px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; min-width: 4px;}
        .bar { width: 100%; border-radius: 2px 2px 0 0; transition: height 0.3s; min-height: 2px; }
        .bar-wrapper:hover .bar { filter: brightness(1.2); }
        /* Tooltip CSS pur */
        .bar-wrapper:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #111827; color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
            white-space: pre; z-index: 50; border: 1px solid #4b5563; pointer-events: none; margin-bottom: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        /* Couleurs Sources */
        .bar-wrapper.real .bar { background-color: #10b981; } /* Vert (GRDF Quotidien) */
        .bar-wrapper.estimated .bar { background-color: #8b5cf6; } /* Violet (Calculé via Index) */
        .bar-wrapper.projected .bar { background-color: #f59e0b; opacity: 0.7; } /* Orange (Projection future) */

        /* Calendrier */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 0.375rem; background-color: #374151; font-size: 0.75rem; position: relative; border: 1px solid transparent; }
        .day-cell.has-data { cursor: pointer; }
        .day-cell.has-data:hover { transform: scale(1.1); z-index: 10; border-color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .day-val { font-weight: 700; margin-top: 2px; font-size: 0.7rem; }
        .intensity-bar { width: 80%; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 2px; overflow: hidden; }
        .intensity-fill { height: 100%; }
        
        /* Marqueurs */
        .marker { position: absolute; top: 2px; right: 2px; width: 5px; height: 5px; border-radius: 50%; }
        .marker.real { background-color: #10b981; box-shadow: 0 0 4px #10b981; }
        .marker.est { background-color: #8b5cf6; }

        /* UI Utils */
        @media print { .print-hidden { display: none !important; } body { background: white !important; color: black !important; } .card { border: 1px solid #ccc !important; box-shadow: none !important; } }
        .fab { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem; border-radius: 9999px; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px rgba(0,0,0,0.3); z-index: 40; }
        @media (min-width: 1024px) { .fab { display: none; } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen pb-24">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center pb-4 border-b border-gray-700 print-hidden gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight">Suivi Conso Gaz</h1>
                <div class="flex items-center gap-2 mt-1 text-sm text-gray-400">
                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-emerald-500 mr-1"></span> Réel (GRDF)</span>
                    <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-violet-500 mr-1"></span> Estimé (Index)</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('import-file').click()" class="flex items-center space-x-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg transition shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Importer (CSV/JSON)</span>
                </button>
                <input type="file" id="import-file" class="hidden" accept=".csv,.json,.txt" onchange="handleImport(this)">
                
                <button onclick="exportData()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition">Sauvegarder</button>
                <button onclick="window.print()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition">Imprimer</button>
            </div>
        </header>

        <!-- CONTENU -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLONNE GAUCHE -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- FORMULAIRE SAISIE -->
                <section class="card p-5 print-hidden lg:block">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Saisie Manuelle (Index)
                    </h2>
                    <form onsubmit="addIndex(event, 'desktop')" class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Date</label>
                            <input type="datetime-local" id="date-desktop" required class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Nouvel Index (m³)</label>
                            <input type="number" id="index-desktop" step="0.001" required placeholder="Ex: 5488" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">Ajouter</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Utilisé pour combler les jours sans données GRDF.</p>
                </section>

                <!-- SYNTHÈSE DYNAMIQUE -->
                <section class="card p-5">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 class="text-lg font-semibold text-white">Synthèse</h2>
                        <div class="flex bg-gray-700 rounded-lg p-1 text-[0.65rem]">
                            <button onclick="setSynth('global')" id="btn-synth-global" class="px-2 py-1 rounded text-white bg-indigo-600">Global</button>
                            <button onclick="setSynth('year')" id="btn-synth-year" class="px-2 py-1 rounded text-gray-300 hover:text-white">An</button>
                            <button onclick="setSynth('month')" id="btn-synth-month" class="px-2 py-1 rounded text-gray-300 hover:text-white">Mois</button>
                        </div>
                    </div>
                    
                    <!-- Filtres dynamiques -->
                    <div id="synth-controls" class="mb-4 hidden">
                        <select id="synth-year-select" onchange="updateSynth()" class="w-full bg-gray-700 text-white text-xs rounded p-2 mb-2 hidden"></select>
                        <input type="month" id="synth-month-select" onchange="updateSynth()" class="w-full bg-gray-700 text-white text-xs rounded p-2 hidden">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600/50">
                            <div class="text-xs text-gray-400 uppercase font-bold">Volume</div>
                            <div class="text-xl font-bold text-blue-400 mt-1" id="disp-m3">0 m³</div>
                            <div class="text-xs text-blue-300/70 mt-1" id="disp-kwh">0 kWh</div>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-lg border border-gray-600/50">
                            <div class="text-xs text-gray-400 uppercase font-bold">Coût TTC</div>
                            <div class="text-xl font-bold text-emerald-400 mt-1" id="disp-cost">0 €</div>
                            <div class="text-xs text-emerald-300/70 mt-1" id="disp-cost-ht">HT: 0 €</div>
                        </div>
                    </div>
                </section>

                <!-- PARAMÈTRES -->
                <section class="card print-hidden">
                    <button onclick="document.getElementById('params').classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center text-sm font-semibold text-gray-300 hover:text-white">
                        <span>Paramètres de Facturation</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="params" class="hidden px-4 pb-4 space-y-3 border-t border-gray-700 pt-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[0.65rem] text-gray-500 uppercase">Prix kWh HT</label><input id="p-kwh" type="number" step="0.0001" value="0.0777" onchange="recalc()" class="w-full bg-gray-800 text-white text-xs rounded p-1 border border-gray-600"></div>
                            <div><label class="text-[0.65rem] text-gray-500 uppercase">Abo/Mois HT</label><input id="p-abo" type="number" step="0.01" value="16.72" onchange="recalc()" class="w-full bg-gray-800 text-white text-xs rounded p-1 border border-gray-600"></div>
                            <div><label class="text-[0.65rem] text-gray-500 uppercase">TVA Conso %</label><input id="p-tva1" type="number" step="0.1" value="20" onchange="recalc()" class="w-full bg-gray-800 text-white text-xs rounded p-1 border border-gray-600"></div>
                            <div><label class="text-[0.65rem] text-gray-500 uppercase">TVA Abo %</label><input id="p-tva2" type="number" step="0.1" value="5.5" onchange="recalc()" class="w-full bg-gray-800 text-white text-xs rounded p-1 border border-gray-600"></div>
                            <div class="col-span-2"><label class="text-[0.65rem] text-gray-500 uppercase">Coef. Conv.</label><input id="p-coef" type="number" step="0.01" value="11.36" onchange="recalc()" class="w-full bg-gray-800 text-white text-xs rounded p-1 border border-gray-600"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- COLONNE DROITE -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- GRAPHIQUE -->
                <section class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white">Évolution</h2>
                        <div class="flex gap-2 text-xs">
                            <button onclick="setChart('day')" id="btn-chart-day" class="px-3 py-1 rounded bg-indigo-600 text-white">Jour</button>
                            <button onclick="setChart('month')" id="btn-chart-month" class="px-3 py-1 rounded bg-gray-700 text-gray-300 hover:text-white">Mois</button>
                        </div>
                    </div>
                    <div id="chart-container" class="bar-container border-b border-gray-600"></div>
                </section>

                <!-- CALENDRIER -->
                <section class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="moveCal(-1)" class="p-1 hover:bg-gray-600 rounded"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button>
                        <h2 class="text-lg font-bold text-white capitalize" id="cal-title">--</h2>
                        <button onclick="moveCal(1)" class="p-1 hover:bg-gray-600 rounded"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                    <div class="calendar-grid mb-2 text-center text-[0.65rem] text-gray-500 font-bold uppercase">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
                    </div>
                    <div id="cal-grid" class="calendar-grid gap-1"></div>
                </section>

                <!-- HISTORIQUE REPLIABLE -->
                <section class="card overflow-hidden">
                    <button onclick="document.getElementById('hist-table').classList.toggle('hidden')" class="w-full p-4 flex justify-between items-center hover:bg-gray-800 transition">
                        <h2 class="text-lg font-semibold text-white">Historique des Index</h2>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="hist-table" class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full text-left text-xs text-gray-400">
                            <thead class="bg-gray-700 text-gray-200 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2">Date</th>
                                    <th class="px-4 py-2 text-right">Index</th>
                                    <th class="px-4 py-2 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="hist-body" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </section>
                
                <div class="flex justify-end print-hidden">
                    <button onclick="resetAll()" class="text-xs text-red-400 hover:underline">Réinitialiser toutes les données</button>
                </div>

            </div>
        </div>
    </div>

    <!-- MOBILE MODAL -->
    <div id="mob-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center print-hidden" onclick="if(e.target===this)this.classList.add('hidden')">
        <div class="bg-gray-800 w-11/12 max-w-md p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Ajouter Index</h2>
            <form onsubmit="addIndex(event, 'mobile')" class="space-y-4">
                <input type="datetime-local" id="date-mobile" required class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600">
                <input type="number" id="index-mobile" step="0.001" required placeholder="Index" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600">
                <button class="w-full bg-indigo-600 text-white font-bold p-3 rounded-lg">Sauvegarder</button>
            </form>
            <button onclick="document.getElementById('mob-modal').classList.add('hidden')" class="mt-4 w-full text-gray-400 text-sm">Annuler</button>
        </div>
    </div>
    <button onclick="openMob()" class="fab print-hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg></button>

    <script>
        // --- DATA STORE ---
        const DB = {
            indexes: [],      // Liste des relevés manuels ou importés {date, index}
            realDays: {},     // Map des consos réelles GRDF {YYYY-MM-DD: {kwh, m3, cost}}
            computedDays: {}, // Map finale (Réel + Estimé)
            monthly: {},      // Agrégats mensuels
            calDate: new Date(),
            chartMode: 'day',
            synthMode: 'global'
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initDates();
            loadDB();
            recalc();
        });

        function initDates() {
            const now = new Date(); 
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const iso = now.toISOString().slice(0, 16);
            if(document.getElementById('date-desktop')) document.getElementById('date-desktop').value = iso;
            if(document.getElementById('date-mobile')) document.getElementById('date-mobile').value = iso;
        }

        // --- PERSISTENCE ---
        function loadDB() {
            try {
                const s = localStorage.getItem('gaz_full_db');
                if(s) {
                    const d = JSON.parse(s);
                    DB.indexes = d.indexes || [];
                    DB.realDays = d.realDays || {};
                }
            } catch(e) { console.error(e); }
        }
        function saveDB() {
            localStorage.setItem('gaz_full_db', JSON.stringify({ indexes: DB.indexes, realDays: DB.realDays }));
        }

        // --- CORE LOGIC (THE HYBRID ENGINE) ---
        function recalc() {
            const P = getParams();
            DB.computedDays = {}; DB.monthly = {};
            let maxD = 0, maxM = 0;

            // 1. INJECT REAL DATA (PRIORITY)
            for (const [k, v] of Object.entries(DB.realDays)) {
                const costHT = v.kwh * P.kwh; // GRDF donne kWh direct souvent, sinon m3*coef
                const costTTC = (costHT * (1 + P.tva1)) + ((P.abo*12/365) * (1 + P.tva2)); // Abo lissé jour
                DB.computedDays[k] = { ...v, cost: costTTC, type: 'real' };
            }

            // 2. FILL GAPS WITH INDEXES
            DB.indexes.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            for(let i=1; i<DB.indexes.length; i++) {
                const prev = DB.indexes[i-1];
                const curr = DB.indexes[i];
                const d1 = new Date(prev.date); 
                const d2 = new Date(curr.date);
                
                // Durée en jours
                const daysDiff = Math.ceil((d2 - d1) / (86400000)); 
                if (daysDiff <= 0) continue;

                // Conso totale période (Index)
                const totM3 = curr.index - prev.index;
                const totKwh = totM3 * P.coef;
                
                // Check ce qu'on a déjà en Réel sur cette période
                let realKwhSum = 0;
                let missingDays = [];

                for(let j=0; j<daysDiff; j++) {
                    const d = new Date(d1); d.setDate(d.getDate() + j);
                    const k = d.toISOString().slice(0,10);
                    if(DB.computedDays[k] && DB.computedDays[k].type === 'real') {
                        realKwhSum += DB.computedDays[k].kwh;
                    } else {
                        missingDays.push(k);
                    }
                }

                // Reste à distribuer
                const remainingKwh = Math.max(0, totKwh - realKwhSum);
                
                if (missingDays.length > 0) {
                    const dailyEst = remainingKwh / missingDays.length;
                    const dailyM3 = (totM3 - (realKwhSum/P.coef)) / missingDays.length; // Approx m3
                    const costDay = (dailyEst * P.kwh * (1+P.tva1)) + ((P.abo*12/365)*(1+P.tva2));

                    missingDays.forEach(dayKey => {
                        if(!DB.computedDays[dayKey]) { // Sécurité
                            DB.computedDays[dayKey] = { 
                                kwh: dailyEst, 
                                m3: Math.max(0, dailyM3),
                                cost: costDay, 
                                type: 'estimated' 
                            };
                        }
                    });
                }
            }

            // 3. AGGREGATE MONTHLY
            for(const [k, v] of Object.entries(DB.computedDays)) {
                const m = k.slice(0,7);
                if(!DB.monthly[m]) DB.monthly[m] = { kwh: 0, cost: 0, m3: 0 };
                DB.monthly[m].kwh += v.kwh;
                DB.monthly[m].cost += v.cost;
                DB.monthly[m].m3 += v.m3;
            }

            updateUI();
        }

        // --- UI UPDATES ---
        function updateUI() {
            renderSynth();
            renderChart();
            renderCal();
            renderHist();
        }

        function renderSynth() {
            // Filter logic
            const filters = document.getElementById('synth-controls');
            const ySel = document.getElementById('synth-year-select');
            const mSel = document.getElementById('synth-month-select');
            
            let start=null, end=null;
            const allKeys = Object.keys(DB.computedDays).sort();
            
            if (STATE_UI.synth === 'year') {
                filters.classList.remove('hidden'); ySel.classList.remove('hidden'); mSel.classList.add('hidden');
                // Populate years
                const years = [...new Set(allKeys.map(k=>k.slice(0,4)))].sort().reverse();
                if(ySel.options.length !== years.length) {
                    ySel.innerHTML = ''; 
                    years.forEach(y => ySel.add(new Option(y, y)));
                }
                const yr = ySel.value || new Date().getFullYear();
                start = new Date(yr,0,1); end = new Date(yr,11,31);
            } else if (STATE_UI.synth === 'month') {
                filters.classList.remove('hidden'); mSel.classList.remove('hidden'); ySel.classList.add('hidden');
                if(!mSel.value) mSel.value = new Date().toISOString().slice(0,7);
                const [y,m] = mSel.value.split('-');
                start = new Date(y, m-1, 1); end = new Date(y, m, 0);
            } else {
                filters.classList.add('hidden');
            }

            let sK=0, sC=0, sM=0;
            let htK=0, htA=0;
            const P = getParams();

            allKeys.forEach(k => {
                const d = new Date(k);
                if (start && d < start) return;
                if (end && d > end) return;
                const v = DB.computedDays[k];
                sK += v.kwh; sC += v.cost; sM += v.m3;
                // Recalcul simple du HT pour affichage
                htK += (v.kwh * P.kwh);
                htA += (P.abo * 12 / 365);
            });

            document.getElementById('disp-m3').innerText = sM.toLocaleString('fr-FR', {maximumFractionDigits:1}) + ' m³';
            document.getElementById('disp-kwh').innerText = Math.round(sK).toLocaleString() + ' kWh';
            document.getElementById('disp-cost').innerText = sC.toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            document.getElementById('disp-cost-ht').innerText = 'HT: ' + (htK+htA).toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
            
            // Update Boutons
            ['global','year','month'].forEach(m => {
                const b = document.getElementById('btn-synth-'+m);
                b.className = (STATE_UI.synth === m) ? "px-2 py-1 rounded text-white bg-indigo-600 transition" : "px-2 py-1 rounded text-gray-300 hover:text-white transition";
            });
        }

        function renderChart() {
            const c = document.getElementById('chart-container'); c.innerHTML='';
            let dataMap = {}, max = 0;
            
            if (STATE_UI.chart === 'day') {
                // Data du mois affiché dans le calendrier
                const y = DB.calDate.getFullYear(), m = DB.calDate.getMonth();
                const days = new Date(y, m+1, 0).getDate();
                for(let d=1; d<=days; d++) {
                    const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const val = DB.computedDays[k] ? DB.computedDays[k].cost : 0;
                    if(val>max) max=val;
                    dataMap[d] = { val, type: DB.computedDays[k]?.type };
                }
            } else {
                dataMap = DB.monthly;
                for(let k in dataMap) if(dataMap[k].cost > max) max = dataMap[k].cost;
            }

            const keys = Object.keys(dataMap).sort();
            if(keys.length === 0) { c.innerHTML='<div class="w-full text-center text-gray-500 text-sm mt-10">Pas de données</div>'; return; }

            keys.forEach(k => {
                const item = dataMap[k];
                const val = STATE_UI.chart === 'day' ? item.val : item.cost;
                const pct = max > 0 ? (val/max*100) : 0;
                
                const div = document.createElement('div');
                div.className = `bar-wrapper ${item.type || 'estimated'}`;
                if (STATE_UI.chart === 'month') div.classList.add('dense'); // Reuse styles
                
                // Tooltip
                const label = STATE_UI.chart === 'day' ? `${k}: ${val.toFixed(2)}€` : `${k}: ${val.toFixed(0)}€`;
                div.setAttribute('data-tooltip', label);

                div.innerHTML = `<div class="bar" style="height:${Math.max(2, pct)}%"></div><div class="bar-label">${k.split('-').pop()}</div>`;
                c.appendChild(div);
            });
            
            // Boutons style
            document.getElementById('btn-chart-day').className = STATE_UI.chart==='day' ? "px-3 py-1 rounded bg-indigo-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";
            document.getElementById('btn-chart-month').className = STATE_UI.chart==='month' ? "px-3 py-1 rounded bg-indigo-600 text-white" : "px-3 py-1 rounded bg-gray-700 text-gray-300";
        }

        function renderCal() {
            const g = document.getElementById('cal-grid'); g.innerHTML='';
            const y = DB.calDate.getFullYear(), m = DB.calDate.getMonth();
            document.getElementById('cal-title').innerText = new Date(y,m,1).toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
            
            const fd = new Date(y,m,1).getDay() || 7;
            const dim = new Date(y,m+1,0).getDate();

            // Max for month
            let lMax = 0;
            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(DB.computedDays[k] && DB.computedDays[k].cost > lMax) lMax = DB.computedDays[k].cost;
            }

            for(let i=1; i<fd; i++) g.appendChild(document.createElement('div'));

            for(let d=1; d<=dim; d++) {
                const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const c = document.createElement('div'); c.className = "day-cell border border-gray-700/50";
                
                if(DB.computedDays[k]) {
                    const data = DB.computedDays[k];
                    c.classList.add('has-data');
                    // Color scale
                    const r = lMax>0 ? data.cost/lMax : 0;
                    let col = '#374151';
                    if(data.cost > 0) {
                        if(r<0.25) col = '#064e3b'; else if(r<0.5) col = '#713f12'; else if(r<0.75) col='#7c2d12'; else col='#7f1d1d';
                    }
                    c.style.backgroundColor = col;

                    // Marker
                    if(data.type === 'real') {
                        const m = document.createElement('div'); m.className='marker real'; c.appendChild(m);
                    } else {
                        const m = document.createElement('div'); m.className='marker est'; c.appendChild(m);
                    }
                    
                    // Content
                    c.innerHTML += `<span class="font-bold text-white z-10">${d}</span><div class="z-10 day-val text-gray-200">${Math.round(data.kwh)}k</div>`;
                    
                    // Bar
                    const b = document.createElement('div'); b.className="intensity-bar";
                    const f = document.createElement('div'); f.className="intensity-fill"; f.style.width=`${r*100}%`; f.style.background = r>0.5?'#fcd34d':'#34d399';
                    b.appendChild(f); c.appendChild(b);

                    c.title = `${k}\n${data.type==='real'?'GRDF':'Estimé'}\n${data.cost.toFixed(2)}€\n${data.kwh.toFixed(1)} kWh`;
                } else {
                    c.innerHTML = `<span class="text-gray-600">${d}</span>`;
                }
                g.appendChild(c);
            }
        }

        function renderHist() {
            const b = document.getElementById('hist-body'); b.innerHTML='';
            [...DB.indexes].reverse().forEach(row => {
                const tr = document.createElement('tr'); tr.className="hover:bg-gray-700/50 border-b border-gray-700 transition";
                const d = new Date(row.date).toLocaleDateString('fr-FR');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-white">${d}</td>
                    <td class="px-4 py-3 text-right font-mono text-gray-300">${row.index}</td>
                    <td class="px-4 py-3 text-center"><button onclick="delIndex(${row.id})" class="text-red-400 hover:text-white">×</button></td>
                `;
                b.appendChild(tr);
            });
        }

        // --- ACTIONS UTILISATEUR ---
        function addIndex(e, m) {
            e.preventDefault(); const suf = m==='mobile'?'-mobile':'-desktop';
            const d = document.getElementById('date'+suf).value;
            const v = parseFloat(document.getElementById('index'+suf).value);
            if(!d || isNaN(v)) return;
            
            // Pas de doublon date
            if(DB.indexes.some(x => x.date === d)) { alert('Date existe déjà'); return; }
            
            DB.indexes.push({ id: Date.now(), date: d, index: v });
            saveDB(); recalc();
            document.getElementById('index'+suf).value = '';
            if(m==='mobile') document.getElementById('mob-modal').classList.add('hidden');
        }

        function delIndex(id) {
            if(confirm("Supprimer ?")) {
                DB.indexes = DB.indexes.filter(x => x.id !== id);
                saveDB(); recalc();
            }
        }

        function resetAll() {
            if(confirm("TOUT EFFACER ?")) {
                localStorage.removeItem('gaz_full_db');
                DB.indexes = []; DB.realDays = {};
                recalc();
            }
        }
        
        // --- IMPORT/EXPORT ---
        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const c = e.target.result;
                try {
                    // 1. JSON BACKUP
                    if(f.name.endsWith('.json') || c.trim().startsWith('{')) {
                        const j = JSON.parse(c);
                        if(j.indexes) DB.indexes = j.indexes;
                        if(j.realDays) DB.realDays = j.realDays;
                        alert("Sauvegarde restaurée !");
                    } 
                    // 2. CSV GRDF
                    else {
                        let countReal = 0, countIndex = 0;
                        const lines = c.split(/\r?\n/);
                        
                        // Détection type simple
                        const isDaily = c.includes("Consommation") && c.includes("Date");

                        lines.forEach(l => {
                            const clean = l.replace(/"/g, '').trim();
                            if(!clean || isNaN(clean.charAt(0))) return;
                            
                            let p = clean.split(';'); if(p.length<2) p=clean.split(',');
                            
                            // Date Parsing (FR)
                            let dateStr = null;
                            const dRaw = p[0].trim();
                            if(dRaw.includes('/')) {
                                const [d,m,y] = dRaw.split('/');
                                if(y) dateStr = `${y}-${m}-${d}`; // YYYY-MM-DD
                            }
                            
                            if(dateStr) {
                                if(isDaily) {
                                    // Format: Date; Conso; ...
                                    // Parfois col 1 ou 2
                                    let val = parseFloat(p[1].replace(',','.'));
                                    if(isNaN(val) && p[2]) val = parseFloat(p[2].replace(',','.'));
                                    
                                    if(!isNaN(val)) {
                                        // GRDF donne m3, on convertit approx kwh pour stockage ou on garde m3
                                        // On stocke brut m3 + kwh calculé par défaut 11.2 si coeff absent
                                        let coef = 11.2;
                                        if(p[2] && !isNaN(parseFloat(p[2].replace(',','.')))) coef = parseFloat(p[2].replace(',','.'));
                                        
                                        DB.realDays[dateStr] = { m3: val, kwh: val*coef };
                                        countReal++;
                                    }
                                } else {
                                    // Format: Date; Type; Index
                                    let idx = parseFloat(p[1].replace(',','.'));
                                    if(isNaN(idx) && p[2]) idx = parseFloat(p[2].replace(',','.'));
                                    
                                    if(!isNaN(idx) && idx > 100) {
                                        // Check doublon
                                        if(!DB.indexes.some(x => x.date.startsWith(dateStr))) {
                                            DB.indexes.push({ id: Date.now()+Math.random(), date: dateStr+"T12:00", index: idx });
                                            countIndex++;
                                        }
                                    }
                                }
                            }
                        });
                        alert(`Importé : ${countReal} jours réels, ${countIndex} index.`);
                    }
                    saveDB(); recalc();
                } catch(err) { alert("Erreur import: "+err.message); }
                input.value = '';
            };
            r.readAsText(f);
        }

        function exportData() {
            const b = new Blob([JSON.stringify({indexes: DB.indexes, realDays: DB.realDays})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b);
            a.download = `backup_gaz_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- UTILS UI ---
        const STATE_UI = { synth: 'global', chart: 'day' };
        function setSynth(m) { STATE_UI.synth = m; updateUI(); }
        function updateSynth() { updateUI(); }
        function setChart(m) { STATE_UI.chart = m; renderChart(); }
        function moveCal(d) { DB.calDate.setMonth(DB.calDate.getMonth()+d); renderCal(); }
        function openMob() { initDates(); document.getElementById('mob-modal').classList.remove('hidden'); }
        function getParams() {
            return {
                kwh: parseFloat(document.getElementById('p-kwh').value)||0.0777,
                abo: parseFloat(document.getElementById('p-abo').value)||16.72,
                coef: parseFloat(document.getElementById('p-coef').value)||11.36,
                tva1: (parseFloat(document.getElementById('p-tva1').value)||20)/100,
                tva2: (parseFloat(document.getElementById('p-tva2').value)||5.5)/100
            };
        }
    </script>
</body>
</html>
