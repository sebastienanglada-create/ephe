<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NÉO-GAZ | Terminal de Contrôle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        cyber: {
                            bg: '#05070a', // Darker black
                            card: '#0f1219',
                            border: '#1e293b',
                            primary: '#06b6d4', // Cyan neon
                            secondary: '#8b5cf6', // Violet
                            success: '#10b981',
                            danger: '#ef4444',
                            text: '#94a3b8'
                        }
                    },
                    boxShadow: {
                        'neon-cyan': '0 0 5px theme("colors.cyan.500"), 0 0 20px theme("colors.cyan.900")',
                        'neon-blue': '0 0 5px theme("colors.blue.500"), 0 0 20px theme("colors.blue.900")',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05070a;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #05070a 70%);
            color: #e2e8f0;
            overflow-x: hidden;
            height: 100dvh;
            max-height: 100dvh;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #05070a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        /* Glassmorphism & Neon */
        .glass-panel {
            background: rgba(15, 18, 25, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
        }

        .hud-border {
            position: relative;
            border: 1px solid rgba(6, 182, 212, 0.5);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2), inset 0 0 20px rgba(6, 182, 212, 0.05);
        }
        
        .hud-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #fff;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        .hud-input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        .numpad-btn {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #06b6d4;
            font-size: 1.25rem;
            font-weight: bold;
            transition: all 0.1s;
        }
        .numpad-btn:active {
            transform: scale(0.95);
            background: rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.4);
        }

        /* Chart Animations */
        .bar-grow {
            transform-origin: bottom;
            animation: grow 0.8s ease-out forwards;
        }
        @keyframes grow { from { transform: scaleY(0); } to { transform: scaleY(1); } }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) sepia(100%) saturate(1000%) hue-rotate(180deg) brightness(1.2);
            opacity: 0.8;
            cursor: pointer;
        }
        
        /* Sidebar Transitions */
        #mainSidebar { transition: width 0.3s ease; }
        .sidebar-text { transition: opacity 0.2s ease; opacity: 1; }
        .sidebar-collapsed .sidebar-text { opacity: 0; display: none; }
        .sidebar-collapsed .logo-container { justify-content: center; padding-left: 0; }
        .sidebar-collapsed .nav-btn { justify-content: center; }
        .sidebar-collapsed .nav-btn span { display: none; }
        .sidebar-collapsed #sidebarLegend { display: none; }
    </style>
</head>
<body class="flex h-[100dvh] overflow-hidden selection:bg-cyan-500 selection:text-black font-sans">

    <!-- SIDEBAR (Collapsible) -->
    <aside id="mainSidebar" class="hidden md:flex w-64 flex-col border-r border-cyber-border bg-cyber-bg/95 backdrop-blur z-20 relative">
        <div class="h-16 flex items-center justify-start px-6 border-b border-cyber-border logo-container transition-all">
            <div class="w-8 h-8 rounded bg-cyan-500/10 border border-cyan-500/50 flex items-center justify-center shadow-[0_0_10px_rgba(6,182,212,0.5)] shrink-0">
                <i data-lucide="flame" class="w-5 h-5 text-cyan-400"></i>
            </div>
            <span class="ml-3 font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 sidebar-text whitespace-nowrap">
                NÉO-GAZ
            </span>
        </div>

        <nav class="flex-1 py-6 space-y-2 px-2">
            <button onclick="openModule()" class="nav-btn w-full flex items-center justify-start p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500/20 hover:shadow-[0_0_15px_rgba(6,182,212,0.3)] transition-all group whitespace-nowrap">
                <i data-lucide="plus-square" class="w-6 h-6 shrink-0"></i>
                <span class="ml-3 font-semibold sidebar-text">Saisie / Import</span>
            </button>
            
            <div class="h-px bg-cyber-border my-4 mx-2"></div>

            <div id="sidebarLegend" class="px-4 py-2">
                <h3 class="text-xs font-semibold text-cyber-text uppercase tracking-wider mb-3 whitespace-nowrap">Légende</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)] shrink-0"></div>
                        <span class="text-xs text-gray-400">Réel</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.8)] shrink-0"></div>
                        <span class="text-xs text-gray-400">Estimé</span>
                    </div>
                </div>
            </div>
        </nav>

        <button onclick="toggleSidebar()" class="absolute bottom-4 right-[-12px] md:static md:w-full md:p-4 flex justify-end md:justify-center text-gray-500 hover:text-cyan-400 transition-colors focus:outline-none">
            <i id="collapseIcon" data-lucide="chevrons-left" class="w-5 h-5"></i>
        </button>

        <div class="p-4 border-t border-cyber-border text-[10px] text-center text-cyber-text opacity-50 sidebar-text whitespace-nowrap">
            SYS.READY
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="h-auto md:h-16 py-2 border-b border-cyber-border bg-cyber-bg/80 backdrop-blur flex flex-wrap items-center justify-between px-4 md:px-8 z-10 gap-2 shrink-0">
            <div class="md:hidden flex items-center gap-2">
                 <div class="w-8 h-8 rounded bg-cyan-500/10 border border-cyan-500/50 flex items-center justify-center">
                    <i data-lucide="flame" class="w-4 h-4 text-cyan-400"></i>
                </div>
                 <h1 class="text-lg font-bold text-gray-200">NÉO-GAZ</h1>
            </div>

            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <div class="flex bg-cyber-card rounded-lg p-1 border border-cyber-border">
                    <button onclick="setFilter('global')" class="filter-btn px-3 py-1 text-xs rounded transition-all text-gray-400 hover:text-white" data-period="global">Global</button>
                    <button onclick="setFilter('year')" class="filter-btn px-3 py-1 text-xs rounded text-gray-400 hover:text-white transition-all" data-period="year">Année</button>
                    <button onclick="setFilter('month')" class="filter-btn px-3 py-1 text-xs rounded transition-all text-white bg-cyan-500/20 active-filter" data-period="month">Mois</button>
                    <button onclick="setFilter('custom')" class="filter-btn px-3 py-1 text-xs rounded text-gray-400 hover:text-white transition-all" data-period="custom">Perso</button>
                </div>
                
                <div id="dateNavigator" class="hidden flex items-center gap-1 border border-cyber-border rounded-lg p-1 bg-cyber-card">
                     <button onclick="changePeriod(-1)" class="p-1 hover:text-cyan-400 transition-colors"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                     <span id="currentPeriodLabel" class="text-xs font-mono text-cyan-400 min-w-[80px] text-center">...</span>
                     <button onclick="changePeriod(1)" class="p-1 hover:text-cyan-400 transition-colors"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>

                <div id="customRangeSelector" class="hidden flex items-center gap-2">
                    <input type="date" id="customStart" onchange="applyCustomFilter()" class="bg-cyber-card border border-cyber-border rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-cyan-500 w-28">
                    <span class="text-gray-500 text-xs">-</span>
                    <input type="date" id="customEnd" onchange="applyCustomFilter()" class="bg-cyber-card border border-cyber-border rounded px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-cyan-500 w-28">
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40 md:pb-12 scroll-smooth">
            
            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="zap" class="w-24 h-24 text-cyan-500"></i>
                    </div>
                    <p class="text-[10px] text-cyan-400 uppercase tracking-widest mb-1">Volume Total</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiKwh">0</h2>
                    <p class="text-xs text-gray-500 mt-1">kWh converti</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="banknote" class="w-24 h-24 text-emerald-500"></i>
                    </div>
                    <p class="text-[10px] text-emerald-400 uppercase tracking-widest mb-1">Coût Estimé</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiCost">0 <span class="text-sm">€</span></h2>
                    <p class="text-xs text-gray-500 mt-1">TTC (Abo. inclus)</p>
                </div>

                <div class="glass-panel rounded-xl p-4 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="bar-chart-3" class="w-24 h-24 text-violet-500"></i>
                    </div>
                    <p class="text-[10px] text-violet-400 uppercase tracking-widest mb-1">Moyenne Jour</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiAvg">0</h2>
                    <p class="text-xs text-gray-500 mt-1">kWh / Jour</p>
               </div>
               
               <div class="glass-panel rounded-xl p-4 relative overflow-hidden group border-dashed border-gray-700">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Fiabilité Données</p>
                    <h2 class="text-2xl md:text-3xl font-bold text-white font-mono" id="kpiReliability">0%</h2>
                    <div class="w-full bg-gray-800 h-1 mt-2 rounded-full overflow-hidden">
                        <div id="reliablityBar" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="glass-panel rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="activity" class="w-4 h-4 text-cyan-400"></i>
                        Flux de Consommation
                    </h3>
                    <div class="flex bg-cyber-bg rounded p-0.5 border border-cyber-border">
                         <button onclick="setChartMode('kwh')" class="chart-mode-btn px-3 py-1 text-[10px] rounded hover:text-white transition-all active-chart-mode" data-mode="kwh">kWh</button>
                         <button onclick="setChartMode('cost')" class="chart-mode-btn px-3 py-1 text-[10px] rounded text-gray-400 hover:text-white transition-all" data-mode="cost">€</button>
                    </div>
                </div>
                <div class="relative h-64 w-full flex items-end justify-between gap-1" id="chartContainer">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-600 text-sm animate-pulse">En attente de données...</div>
                </div>
                <div class="flex justify-between mt-2 px-1 text-[10px] text-gray-500 font-mono" id="chartLabels"></div>
            </div>

            <!-- Heatmap & History -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-panel rounded-xl p-6">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2 uppercase tracking-wider">
                        <i data-lucide="layout-grid" class="w-4 h-4 text-violet-400"></i>
                        Matrice Temporelle
                    </h3>
                    <div class="grid grid-cols-7 gap-1 md:gap-2 mb-2">
                        <div class="text-center text-[10px] text-gray-500">L</div>
                        <div class="text-center text-[10px] text-gray-500">M</div>
                        <div class="text-center text-[10px] text-gray-500">M</div>
                        <div class="text-center text-[10px] text-gray-500">J</div>
                        <div class="text-center text-[10px] text-gray-500">V</div>
                        <div class="text-center text-[10px] text-gray-500">S</div>
                        <div class="text-center text-[10px] text-gray-500">D</div>
                    </div>
                    <div id="heatmapGrid" class="grid grid-cols-7 gap-1 md:gap-2"></div>
                </div>

                <div class="glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-full max-h-[400px]">
                    <div class="p-4 border-b border-gray-800 bg-black/20">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="database" class="w-4 h-4 text-emerald-400"></i>
                            Logs Index
                        </h3>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-1" id="historyList"></div>
                </div>
            </div>
            
            <div class="h-10 md:hidden"></div>
        </div>
    </main>

    <button onclick="openModule()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-cyan-600 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(8,145,178,0.6)] z-40 hover:scale-110 transition-transform border border-cyan-400">
        <i data-lucide="plus" class="w-6 h-6 text-white"></i>
    </button>

    <!-- HUD Overlay -->
    <div id="hudOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div id="hudContent" class="hud-border bg-[#0a0c10] w-[95%] max-w-2xl max-h-[90dvh] flex flex-col rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative">
            <button onclick="closeModule()" class="absolute top-4 right-4 text-cyan-600 hover:text-cyan-400 z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="p-4 md:p-6 border-b border-gray-800 text-center relative overflow-hidden shrink-0">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                <h2 class="text-lg md:text-xl font-bold text-white tracking-[0.2em] uppercase neon-text-cyan">Entrée Données</h2>
                <p class="text-[10px] text-cyan-700 uppercase mt-1">Terminal de Saisie</p>
            </div>
            <div class="overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 h-full">
                    <div class="p-4 md:p-6 space-y-4 border-b md:border-b-0 md:border-r border-gray-800 relative">
                        <div class="space-y-1">
                            <label class="text-[10px] text-cyan-500 uppercase tracking-wider font-bold block">Date du Relevé</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1"><input type="date" id="hudDate" class="hud-input w-full px-3 py-2 rounded text-base text-center" onfocus="setActiveInput('none')"></div>
                                <div class="relative w-24"><input type="time" id="hudTime" class="hud-input w-full px-1 py-2 rounded text-base text-center" onfocus="setActiveInput('none')"></div>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-cyan-500 uppercase tracking-wider font-bold block">Index Compteur (m³)</label>
                            <div class="relative">
                                <input type="number" id="hudIndex" step="0.001" placeholder="00000.0" class="hud-input w-full px-4 py-3 rounded-lg text-xl font-mono text-cyan-400 tracking-widest text-center" onfocus="setActiveInput('index')" readonly>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 text-xs">m³</div>
                            </div>
                        </div>
                        <div class="p-2 rounded bg-cyan-900/10 border border-cyan-900/30 text-center">
                            <span class="text-[10px] text-gray-500 uppercase">Dernier Index</span>
                            <div class="text-xs text-gray-300 font-mono" id="lastIndexDisplay">--</div>
                        </div>
                    </div>
                    <div class="p-4 bg-[#050608] min-h-[250px]">
                        <div class="grid grid-cols-3 gap-2 h-full">
                            <button onclick="numpadPress('1')" class="numpad-btn rounded py-3">1</button>
                            <button onclick="numpadPress('2')" class="numpad-btn rounded py-3">2</button>
                            <button onclick="numpadPress('3')" class="numpad-btn rounded py-3">3</button>
                            <button onclick="numpadPress('4')" class="numpad-btn rounded py-3">4</button>
                            <button onclick="numpadPress('5')" class="numpad-btn rounded py-3">5</button>
                            <button onclick="numpadPress('6')" class="numpad-btn rounded py-3">6</button>
                            <button onclick="numpadPress('7')" class="numpad-btn rounded py-3">7</button>
                            <button onclick="numpadPress('8')" class="numpad-btn rounded py-3">8</button>
                            <button onclick="numpadPress('9')" class="numpad-btn rounded py-3">9</button>
                            <button onclick="numpadPress('.')" class="numpad-btn rounded py-3 text-xl">.</button>
                            <button onclick="numpadPress('0')" class="numpad-btn rounded py-3">0</button>
                            <button onclick="numpadPress('DEL')" class="numpad-btn rounded py-3 text-red-400 border-red-900/30 hover:bg-red-900/20"><i data-lucide="delete" class="w-5 h-5 mx-auto"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[#0f1219] border-t border-gray-800 flex flex-col md:flex-row items-center justify-between gap-3 shrink-0">
                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                    <button onclick="document.getElementById('fileImport').click()" class="flex-1 md:flex-none px-3 py-2 rounded border border-gray-700 hover:border-emerald-500 text-[10px] md:text-xs text-gray-400 hover:text-emerald-400 transition-colors flex items-center justify-center gap-1 whitespace-nowrap"><i data-lucide="upload" class="w-3 h-3"></i> Import</button>
                    <button onclick="exportData()" class="flex-1 md:flex-none px-3 py-2 rounded border border-gray-700 hover:border-violet-500 text-[10px] md:text-xs text-gray-400 hover:text-violet-400 transition-colors flex items-center justify-center gap-1 whitespace-nowrap"><i data-lucide="save" class="w-3 h-3"></i> Sauve</button>
                    <button onclick="toggleSettings()" class="px-3 py-2 rounded border border-gray-700 hover:border-gray-500 text-gray-400 transition-colors"><i data-lucide="settings" class="w-4 h-4"></i></button>
                </div>
                <button onclick="submitHudForm()" class="w-full md:w-auto px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold tracking-wider rounded shadow-[0_0_20px_rgba(8,145,178,0.4)] transition-all transform active:scale-95 text-sm">VALIDER</button>
            </div>
            <input type="file" id="fileImport" class="hidden" accept=".json,.csv">
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsOverlay" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm border border-gray-800 bg-[#0a0c10] shadow-2xl relative">
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-white font-bold uppercase tracking-wider text-sm flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4 text-cyan-400"></i>Configuration</h3>
                <button onclick="document.getElementById('settingsOverlay').classList.add('hidden')" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
             </div>
             <div class="space-y-4">
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Prix kWh HT (€)</label><input type="number" id="setPrice" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors"></div>
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Abonnement Annuel HT (€)</label><input type="number" id="setSub" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors"></div>
                <div><label class="text-[10px] text-cyan-600 uppercase tracking-wider font-bold mb-1 block">Coef. Conversion (m³ -> kWh)</label><input type="number" id="setCoef" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-white focus:border-cyan-500 focus:outline-none transition-colors"></div>
                <button onclick="saveSettings()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(8,145,178,0.4)] mt-2 transition-all tracking-wider text-sm">ENREGISTRER</button>
                <div class="pt-4 mt-4 border-t border-gray-800">
                    <button onclick="resetData()" class="w-full py-3 rounded border border-red-900/50 text-red-500 hover:bg-red-900/20 hover:border-red-500 flex items-center justify-center gap-2 transition-all group"><i data-lucide="trash-2" class="w-4 h-4 group-hover:animate-bounce"></i><span class="font-bold text-xs uppercase tracking-widest">EFFACER TOUTES LES DONNÉES</span></button>
                    <p class="text-[9px] text-gray-600 text-center mt-2">Action irréversible.</p>
                </div>
             </div>
        </div>
    </div>

    <script>
        const DEFAULT_SETTINGS = { kwhPrice: 0.1045, subscription: 245.50, tva: 0.20, conversionCoef: 11.2 };
        let state = { settings: { ...DEFAULT_SETTINGS }, readings: [], importedData: {}, computedDaily: [], ui: { periodFilter: 'month', currentDate: new Date(), chartMode: 'kwh' } };

        function init() {
            if (window.lucide) lucide.createIcons();
            loadData();
            recalcEngine();
            document.getElementById('setPrice').value = state.settings.kwhPrice;
            document.getElementById('setSub').value = state.settings.subscription;
            document.getElementById('setCoef').value = state.settings.conversionCoef;
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);
            document.getElementById('customStart').valueAsDate = lastMonth;
            document.getElementById('customEnd').valueAsDate = today;
        }

        function loadData() {
            const s = localStorage.getItem('gt_settings'), r = localStorage.getItem('gt_readings'), i = localStorage.getItem('gt_imports');
            if (s) state.settings = JSON.parse(s);
            if (r) state.readings = JSON.parse(r);
            if (i) state.importedData = JSON.parse(i);
        }
        function saveData() {
            localStorage.setItem('gt_settings', JSON.stringify(state.settings));
            localStorage.setItem('gt_readings', JSON.stringify(state.readings));
            localStorage.setItem('gt_imports', JSON.stringify(state.importedData));
        }

        // HUD & Keypad
        let activeInput = 'hudIndex';
        function openModule() {
            const o = document.getElementById('hudOverlay'), c = document.getElementById('hudContent');
            o.classList.remove('hidden');
            setTimeout(() => { o.classList.remove('opacity-0'); c.classList.remove('scale-95'); c.classList.add('scale-100'); }, 10);
            const now = new Date();
            document.getElementById('hudDate').valueAsDate = now;
            document.getElementById('hudTime').value = now.toTimeString().substring(0, 5);
            document.getElementById('hudIndex').value = '';
            if(state.readings.length > 0) {
                const last = [...state.readings].sort((a,b) => (new Date(a.date + 'T' + (a.time||'00:00')) - new Date(b.date + 'T' + (b.time||'00:00')))).pop();
                document.getElementById('lastIndexDisplay').innerText = `${last.value.toLocaleString()} m³ (${new Date(last.date).toLocaleDateString()})`;
            } else document.getElementById('lastIndexDisplay').innerText = "Aucun historique";
            activeInput = 'hudIndex';
        }
        function closeModule() {
            const o = document.getElementById('hudOverlay'), c = document.getElementById('hudContent');
            o.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95');
            setTimeout(() => o.classList.add('hidden'), 300);
        }
        function setActiveInput(id) { if(id !== 'none') activeInput = id; }
        function numpadPress(k) {
            const i = document.getElementById(activeInput);
            if (!i) return;
            if (k === 'DEL') i.value = i.value.slice(0, -1);
            else { if (k === '.' && i.value.includes('.')) return; i.value += k; }
        }
        function submitHudForm() {
            const d = document.getElementById('hudDate').value, t = document.getElementById('hudTime').value || "00:00", v = parseFloat(document.getElementById('hudIndex').value);
            if (!d || isNaN(v)) { alert("Erreur de saisie"); return; }
            const ex = state.readings.find(r => r.date === d && (r.time || "00:00") === t);
            if (ex) { if(!confirm("Écraser ?")) return; ex.value = v; } else state.readings.push({ date: d, time: t, value: v });
            saveData(); recalcEngine(); closeModule();
        }

        function toggleSidebar() {
            const s = document.getElementById('mainSidebar'), i = document.getElementById('collapseIcon');
            if(s.classList.contains('w-20')) { s.classList.remove('w-20','sidebar-collapsed'); s.classList.add('w-64'); i.setAttribute('data-lucide', 'chevrons-left'); }
            else { s.classList.remove('w-64'); s.classList.add('w-20','sidebar-collapsed'); i.setAttribute('data-lucide', 'chevrons-right'); }
            if(window.lucide) lucide.createIcons();
        }

        // CSV/JSON Import Logic (FIXED & ROBUST)
        document.getElementById('fileImport').addEventListener('change', function(e) {
            const f = e.target.files[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const txt = evt.target.result;
                let done = false;
                
                // 1. JSON
                try {
                    const j = JSON.parse(txt);
                    if (j.readings || j.indexes) {
                        if(j.readings) { state.readings = j.readings; state.settings = j.settings||state.settings; state.importedData = j.importedData||state.importedData; }
                        else if(j.indexes) {
                            j.indexes.forEach(x => {
                                if(x.date && x.index!==undefined) {
                                    const ps = x.date.split('T'), d = ps[0], t = ps[1]?ps[1].substring(0,5):"00:00";
                                    if(!state.readings.some(r=>r.date===d&&(r.time||"00:00")===t)) state.readings.push({date:d, time:t, value:x.index});
                                }
                            });
                            Object.keys(j).forEach(k => { if(/^\d{4}-\d{2}-\d{2}$/.test(k) && j[k].m3!==undefined) state.importedData[k]=j[k].m3; });
                        }
                        done = true; alert("Backup JSON importé.");
                    }
                } catch(e) {}

                // 2. CSV Robust (Accent Insensitive)
                if (!done) {
                    const lines = txt.split(/\r\n|\n/).filter(l => l.trim() !== '');
                    let type = 'unknown';
                    
                    // Fuzzy detection (ignores encoding/accents)
                    const scan = lines.slice(0, 50).join('\n').toLowerCase();
                    if(scan.includes("date de relev") || scan.includes("type d'index") || scan.includes("index (m3)")) type = 'index';
                    else if(scan.includes("date de conso")) type = 'daily';
                    else if(scan.includes("riode de conso")) type = 'monthly';

                    if (type === 'unknown') { alert("Format CSV non reconnu."); return; }

                    let count = 0;
                    let latestDate = null;

                    lines.forEach(l => {
                        const lowL = l.toLowerCase();
                        if(lowL.startsWith('ann') || lowL.includes('date de') || lowL.includes('riode de')) return;
                        
                        const parts = l.split(';').map(p => p.replace(/"/g, '').trim());
                        if(parts.length < 2) return;

                        if (type === 'monthly') {
                            // MM/YYYY
                            const mMatch = parts[0].match(/(\d{2})\/(\d{4})/);
                            if(mMatch) {
                                const [_, m, y] = mMatch;
                                const val = parseFloat(parts[1].replace(',', '.').replace(/\s/g, ''));
                                if(!isNaN(val)) {
                                    const days = new Date(y, m, 0).getDate();
                                    const daily = val / days;
                                    for(let d=1; d<=days; d++) {
                                        const iso = `${y}-${m}-${String(d).padStart(2,'0')}`;
                                        if(state.importedData[iso] === undefined) state.importedData[iso] = daily;
                                        if(!latestDate || iso > latestDate) latestDate = iso;
                                    }
                                    count++;
                                }
                            }
                        } else {
                            // DD/MM/YYYY
                            const dMatch = parts[0].match(/(\d{2})\/(\d{2})\/(\d{4})/);
                            if(dMatch) {
                                const [_, d, m, y] = dMatch;
                                const iso = `${y}-${m}-${d}`;
                                let vStr = (type === 'daily') ? parts[1] : parts[2];
                                if(vStr) {
                                    const val = parseFloat(vStr.replace(',', '.').replace(/\s/g, ''));
                                    if(!isNaN(val)) {
                                        if(type === 'daily') state.importedData[iso] = val;
                                        else {
                                            const ex = state.readings.find(r => r.date === iso);
                                            if(ex) ex.value = val;
                                            else state.readings.push({ date: iso, time: "00:00", value: val });
                                        }
                                        if(!latestDate || iso > latestDate) latestDate = iso;
                                        count++;
                                    }
                                }
                            }
                        }
                    });
                    
                    if(latestDate) state.ui.currentDate = new Date(latestDate);
                    alert(`${count} entrées importées.`);
                }
                saveData(); recalcEngine(); e.target.value = '';
            };
            reader.readAsText(f); // Default encoding is usually UTF-8, if files are ANSI/Latin1, accents break but fuzzy match handles it.
        });

        function exportData() {
            const d = new Date().toISOString().split('T')[0];
            const uri = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const a = document.createElement('a'); a.href = uri; a.download = `gaz_backup_${d}.json`; document.body.appendChild(a); a.click(); a.remove();
        }
        function toggleSettings() { document.getElementById('settingsOverlay').classList.remove('hidden'); }
        function saveSettings() {
            state.settings.kwhPrice = parseFloat(document.getElementById('setPrice').value);
            state.settings.subscription = parseFloat(document.getElementById('setSub').value);
            state.settings.conversionCoef = parseFloat(document.getElementById('setCoef').value);
            saveData(); recalcEngine(); document.getElementById('settingsOverlay').classList.add('hidden');
        }
        function resetData() { if(confirm("Effacer TOUT ?")) { localStorage.clear(); location.reload(); } }

        function recalcEngine() {
            state.readings.sort((a,b) => (new Date(a.date+'T'+(a.time||'00:00')) - new Date(b.date+'T'+(b.time||'00:00'))));
            const dailyMap = new Map();
            if (state.readings.length < 2) { state.computedDaily=[]; updateUI(); return; }

            for(let i=0; i<state.readings.length-1; i++) {
                const s = state.readings[i], e = state.readings[i+1];
                if (s.date === e.date) {
                    const d = s.date;
                    const delta = e.value - s.value;
                    if(!dailyMap.has(d)) dailyMap.set(d, {m3:0, kwh:0, type:'real'});
                    const entry = dailyMap.get(d);
                    entry.m3 += delta; entry.kwh += delta*state.settings.conversionCoef;
                    continue;
                }
                const rangeDays = [];
                let curr = new Date(s.date);
                const endD = new Date(e.date);
                while(curr < endD) {
                    rangeDays.push(curr.toISOString().split('T')[0]);
                    curr.setDate(curr.getDate()+1);
                }
                if(rangeDays.length===0) continue;

                let realVol = 0, realCount = 0;
                rangeDays.forEach(d => { if(state.importedData[d]!==undefined) { realVol+=state.importedData[d]; realCount++; } });
                
                const diffVal = (e.value - s.value);
                const remVol = diffVal - realVol;
                const remDays = rangeDays.length - realCount;
                const avg = remDays > 0 ? remVol / remDays : 0;

                rangeDays.forEach(d => {
                    let v = 0, t = 'estimated';
                    if(state.importedData[d]!==undefined) { v=state.importedData[d]; t='real'; }
                    else v = avg;
                    if(v<0) v=0;
                    
                    if(!dailyMap.has(d)) dailyMap.set(d, {m3:0, kwh:0, type:t});
                    const ent = dailyMap.get(d);
                    ent.m3 += v; ent.kwh += v*state.settings.conversionCoef;
                    if(t==='real') ent.type='real';
                });
            }
            state.computedDaily = Array.from(dailyMap.entries()).map(([d,v])=>({date:d, ...v})).sort((a,b)=>new Date(a.date)-new Date(b.date));
            updateUI();
        }

        function updateUI() {
            let data = state.computedDaily;
            const target = state.ui.currentDate;
            const nav = document.getElementById('dateNavigator'), cust = document.getElementById('customRangeSelector'), lbl = document.getElementById('currentPeriodLabel');
            nav.classList.add('hidden'); cust.classList.add('hidden');

            if(state.ui.periodFilter === 'year') {
                data = data.filter(d => new Date(d.date).getFullYear() === target.getFullYear());
                lbl.innerText = target.getFullYear(); nav.classList.remove('hidden');
            } else if(state.ui.periodFilter === 'month') {
                data = data.filter(d => { const x=new Date(d.date); return x.getMonth()===target.getMonth() && x.getFullYear()===target.getFullYear(); });
                lbl.innerText = target.toLocaleDateString('fr-FR', {month:'short', year:'numeric'}); nav.classList.remove('hidden');
            } else if(state.ui.periodFilter === 'custom') {
                cust.classList.remove('hidden');
                const s = new Date(document.getElementById('customStart').value), e = new Date(document.getElementById('customEnd').value);
                if(s&&e) data = data.filter(d => { const x=new Date(d.date); return x>=s && x<=e; });
            }

            const kwh = data.reduce((a,b)=>a+b.kwh,0), days = data.length;
            const cost = (kwh * state.settings.kwhPrice) + (state.settings.subscription * (days/365));
            const ttc = cost * (1+state.settings.tva);
            const realC = data.filter(d=>d.type==='real').length;

            document.getElementById('kpiKwh').innerText = Math.round(kwh).toLocaleString();
            document.getElementById('kpiCost').innerHTML = ttc.toFixed(2) + ' <span class="text-sm">€</span>';
            document.getElementById('kpiAvg').innerText = (days>0?kwh/days:0).toFixed(1);
            const rel = days>0?(realC/days)*100:0;
            document.getElementById('kpiReliability').innerText = Math.round(rel) + '%';
            document.getElementById('reliablityBar').style.width = rel + '%';

            renderChart(data);
            renderHeatmap(data);
            renderHistory();
        }

        function renderChart(data) {
            const c = document.getElementById('chartContainer'), l = document.getElementById('chartLabels');
            c.innerHTML=''; l.innerHTML='';
            if(data.length===0) { c.innerHTML='<div class="absolute inset-0 flex items-center justify-center text-gray-700 text-xs">Pas de données</div>'; return; }
            
            let items = data;
            if(data.length > 35) {
                const g = {};
                data.forEach(d => {
                    const k = d.date.substring(0,7);
                    if(!g[k]) g[k]={val:0, date:d.date, type:d.type};
                    g[k].val += (state.ui.chartMode==='kwh'?d.kwh:(d.kwh*state.settings.kwhPrice));
                });
                items = Object.values(g);
            } else {
                items = data.map(d => ({val: state.ui.chartMode==='kwh'?d.kwh:(d.kwh*state.settings.kwhPrice), date:d.date, type:d.type}));
            }
            const max = Math.max(...items.map(i=>i.val)) || 1;
            items.forEach((i, idx) => {
                const h = (i.val/max)*100;
                const col = i.type==='real'?'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]':'bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.5)]';
                const el = document.createElement('div');
                el.className = `flex-1 mx-[1px] rounded-t-sm ${col} bar-grow opacity-80 hover:opacity-100 relative group`;
                el.style.height = `${h}%`; el.style.animationDelay = `${idx*20}ms`;
                el.innerHTML = `<div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-black text-[10px] p-1 rounded border border-gray-700 whitespace-nowrap z-20">${i.val.toFixed(1)}</div>`;
                c.appendChild(el);
            });
            if(data.length<=35) {
                l.innerHTML = `<div class="w-full flex justify-between text-[10px] text-gray-500"><span>${new Date(items[0].date).toLocaleDateString()}</span><span>${new Date(items[items.length-1].date).toLocaleDateString()}</span></div>`;
            } else {
                l.innerHTML = `<div class="w-full flex justify-between text-[10px] text-gray-500"><span>${new Date(items[0].date).getFullYear()}</span><span>${new Date(items[items.length-1].date).getFullYear()}</span></div>`;
            }
        }

        function renderHeatmap(data) {
            const g = document.getElementById("heatmapGrid"); g.innerHTML = '';
            let target = state.ui.currentDate;
            if(state.ui.periodFilter==='global') target = new Date();
            const y = target.getFullYear(), m = target.getMonth();
            const dim = new Date(y, m+1, 0).getDate();
            const off = new Date(y, m, 1).getDay();
            const start = off===0?6:off-1;
            
            for(let i=0; i<start; i++) g.innerHTML+='<div></div>';
            
            const rel = state.computedDaily.filter(d => { const x=new Date(d.date); return x.getMonth()===m && x.getFullYear()===y; });
            const max = Math.max(...rel.map(d=>d.m3), 1);

            for(let d=1; d<=dim; d++) {
                const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const f = rel.find(x=>x.date===iso);
                const el = document.createElement('div');
                el.className = "aspect-square rounded flex items-center justify-center text-[9px] text-gray-500 relative group cursor-default";
                el.innerText = d;
                if(f) {
                    const a = 0.2 + (f.m3/max)*0.8;
                    const c = f.type==='real' ? `rgba(16,185,129,${a})` : `rgba(6,182,212,${a})`;
                    el.style.backgroundColor = c; el.style.color = '#fff';
                    const cost = f.kwh * state.settings.kwhPrice * (1+state.settings.tva);
                    el.innerHTML += `<div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 z-30 bg-black p-2 rounded border border-gray-700 whitespace-nowrap shadow-xl">
                        <div class="font-bold text-white text-xs mb-1">${new Date(f.date).toLocaleDateString()}</div>
                        <div class="flex justify-between gap-3 text-[10px]"><span class="text-cyan-400">${f.m3.toFixed(1)} m³</span><span class="text-emerald-400 font-bold">${cost.toFixed(2)} €</span></div></div>`;
                } else el.style.backgroundColor = 'rgba(255,255,255,0.05)';
                g.appendChild(el);
            }
        }

        function renderHistory() {
            const h = document.getElementById('historyList'); h.innerHTML = '';
            const s = [...state.readings].sort((a,b) => (new Date(b.date+'T'+(b.time||'00:00')) - new Date(a.date+'T'+(a.time||'00:00'))));
            s.forEach((r, i) => {
                let det = '';
                if(i < s.length-1) {
                    const prev = s[i+1];
                    const diff = r.value - prev.value;
                    const days = Math.ceil(Math.abs(new Date(r.date)-new Date(prev.date))/(1000*60*60*24));
                    if(diff>=0) {
                        const cost = (diff*state.settings.conversionCoef*state.settings.kwhPrice + (state.settings.subscription/365)*days)*(1+state.settings.tva);
                        det = `<div class="text-[10px] text-gray-500 mt-1 flex justify-between"><span>+${diff.toFixed(1)} m³ / ${days}j</span><span class="text-emerald-400 font-bold">${cost.toFixed(2)} €</span></div>`;
                    }
                }
                const div = document.createElement('div');
                div.className = "bg-gray-900/50 p-3 rounded border border-gray-800 hover:border-gray-700 transition-colors";
                div.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-400 font-mono flex flex-col"><span>${new Date(r.date).toLocaleDateString()}</span><span class="text-[9px] text-gray-600">${r.time||'00:00'}</span></span><div class="flex items-center gap-2"><span class="text-sm font-bold text-cyan-400 font-mono">${r.value.toLocaleString()} <span class="text-[10px] text-gray-600">m³</span></span><button onclick="delReading('${r.date}', '${r.time||''}')" class="text-red-900 hover:text-red-500"><i data-lucide="trash" class="w-3 h-3"></i></button></div></div>${det}`;
                h.appendChild(div);
            });
        }

        function setFilter(p) { state.ui.periodFilter = p; 
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('text-white', 'bg-cyan-500/20'); b.classList.add('text-gray-400');
                if(b.dataset.period===p) { b.classList.add('text-white', 'bg-cyan-500/20'); b.classList.remove('text-gray-400'); }
            });
            updateUI();
        }
        function applyCustomFilter() { if(state.ui.periodFilter === 'custom') updateUI(); }
        function setChartMode(m) { state.ui.chartMode = m; 
             document.querySelectorAll('.chart-mode-btn').forEach(b => {
                b.classList.remove('text-white', 'bg-cyan-500/20'); b.classList.add('text-gray-400');
                if(b.dataset.mode===m) { b.classList.add('text-white', 'bg-cyan-500/20'); b.classList.remove('text-gray-400'); }
            });
            updateUI();
        }
        function changePeriod(d) {
            const dt = state.ui.currentDate;
            if(state.ui.periodFilter === 'year') dt.setFullYear(dt.getFullYear()+d);
            else dt.setMonth(dt.getMonth()+d);
            state.ui.currentDate = new Date(dt);
            updateUI();
        }
        function delReading(d, t) {
            if(confirm('Supprimer ?')) { 
                state.readings = state.readings.filter(r => !(r.date === d && (r.time || '00:00') === (t || '00:00')));
                saveData(); recalcEngine(); 
            }
        }

        init();
    </script>
</body>
</html>
